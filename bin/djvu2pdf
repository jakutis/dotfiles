#!/usr/bin/env bash

if [ -z "$1" ]
then
    echo "Error: please specify djvu file" >&1
    exit 1
fi

DJVU="$(realpath "$1")"

if ! [ -f "$DJVU" ]
then
    echo "Error: specified djvu file "$DJVU" does not exist" >&1
    exit 1
fi

if [ -z "$2" ]
then
    echo "Error: please specify pdf file" >&1
    exit 1
fi

PDF="$(realpath "$2")"

if [ -e "$PDF" ]
then
    echo "Error: specified pdf file "$PDF" already exists" >&1
    exit 1
fi

if [ -n "$3" ]
then
    PAGESTART="$3"
else
    PAGESTART="1"
fi

if [ -n "$4" ]
then
    PAGEFINISH="$4"
else
    PAGEFINISH="$(djvused "$DJVU" -e 'n')"
fi

DIR="$(mktemp --directory)"
mkdir -p "$DIR"
cd "$DIR"
for PAGE in $(seq --equal-width "$PAGESTART" "$PAGEFINISH")
do
    echo "Page $PAGE from interval [$PAGESTART; $PAGEFINISH]"
    mkdir "page-$PAGE"
    cd "page-$PAGE"
    djvu2hocr -p $PAGE "$DJVU" | sed 's/ocrx/ocr/g' > page.html
    ddjvu -format=tiff -page=$PAGE "$DJVU" page.tif > /dev/null
    pdfbeads -o ../page-${PAGE}.pdf > /dev/null
    cd ..
done
pdftk $(ls *pdf) cat output "$PDF"
cd /
rm -rf "$DIR"
