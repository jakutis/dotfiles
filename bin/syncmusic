#!/usr/bin/env bash

CFG="$1"
if ! [ -e "$CFG" ]
then
    echo Config file "$CFG" does not exist
    exit 1
fi

PODCASTLIST="$(cat "$CFG" | awk 'NR==1{print;exit}')"
PODCASTDIR="$(cat "$CFG" | awk 'NR==2{print;exit}')"
SOUNDCLOUD="$(cat "$CFG" | awk 'NR==3{print;exit}')"

function fix_podcast_tags {
    PODCAST="$1"
    ls $PODCASTDIR/$PODCAST/*.mp3 | (
        while read FILE
        do
            INFO="$(audiotools info "$FILE")"
            TITLE="$(basename "$FILE" .mp3)"
            if ! [ "$(echo "$INFO" | awk 'NR==1{print;exit}')" = "$PODCAST" -a "$(echo "$INFO" | awk 'NR==2{print;exit}')" = "$TITLE" -a "$(echo "$INFO" | awk 'NR==3{print;exit}')" = "$PODCAST" ]
            then
                eyeD3 --remove-all "$FILE"
                id3tag --artist="$PODCAST" --song="$TITLE" --album="$PODCAST" "$FILE"
            fi
        done
    )
}

for PODCAST in $SOUNDCLOUD
do
    DIR="$PODCASTDIR/$PODCAST"
    mkdir "$DIR" -p
    echo "scsync $PODCAST"
    scsync --directory="$DIR" --artist="$PODCAST"
    echo "tag $PODCAST"
    fix_podcast_tags "$PODCAST"
done

cat "$PODCASTLIST" | (
    while read PODCAST
    do
        URL="${PODCAST#* }"
        PODCAST="${PODCAST%% *}"
        DIR="$PODCASTDIR/$PODCAST"
        echo "podcatcher $PODCAST"
        mkdir "$DIR" -p
        podcatcher -d "$PODCASTDIR/.podcatcher" -D "$DIR" --no-perfeed -s 0 -S chron -m 0 -f 0 "$URL"
        echo "tag $PODCAST"
        fix_podcast_tags "$PODCAST"
    done
)
