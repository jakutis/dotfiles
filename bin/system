#!/usr/bin/env bash

if [ "$(id -u)" != "0" ]
then
  ARGS="$@"
  if [ -t 1 ]
  then
      SUDO="sudo"
  else
      SUDO="gksudo"
  fi
  $SUDO -- bash -c "XAUTHORITY="$HOME/.Xauthority" HOME="$HOME" "$0" $ARGS"
  exit
fi

CMD="$1"

function help {
    echo "Available commands: help hibernate poweroff reboot net powersave screens brightness"
}

if [ -z "$CMD" ]
then
    echo "Error: no command given" 1>&2
    help 1>&2
    exit 1
fi

case "$CMD" in
    "brightness")
        DIR="$XDG_CONFIG_HOME/dotfiles/brightness"
        ARG="$2"

        if ! [ -d "$DIR" ]
        then
            echo "Symlink $DIR does not exist, please create it, e.g. ln -s /sys/devices/pci0000:00/0000:00:02.0/backlight/acpi_video0 \"$DIR\"" 1>&2
            exit 1
        fi
        CURRENT="$(cat "$DIR/brightness")"
        MAX="$(cat "$DIR/max_brightness")"
        MIN="0"
        RANGE=$(($MAX - $MIN))
        STEP=$(($RANGE / 20))

        if [ "$ARG" = "" ]
        then
            echo "$CURRENT"
        elif [ "$ARG" = "save" ]
        then
            echo "$CURRENT" > "$XDG_CONFIG_HOME/dotfiles/lastbrightness"
        elif [ "$ARG" = "saved" ]
        then
            cat "$XDG_CONFIG_HOME/dotfiles/lastbrightness" > "$DIR/brightness"
        elif [ "$ARG" = "more" ]
        then
            echo $(($CURRENT + $STEP)) > "$DIR/brightness"
        elif [ "$ARG" = "less" ]
        then
            echo $(($CURRENT - $STEP)) > "$DIR/brightness"
        elif [ "$ARG" = "max" ]
        then
            echo "$MAX" > "$DIR/brightness"
        elif [ "$ARG" = "min" ]
        then
            echo "$MIN" > "$DIR/brightness"
        else
            echo $ARG > "$DIR/brightness"
        fi
        ;;
    "screens")
        DOTFILES="$(cat "$XDG_CONFIG_HOME/dotfiles/dotfiles")"
        MACHINE="$(cat "$XDG_CONFIG_HOME/dotfiles/machine")"
        "$DOTFILES/screens.$MACHINE/$2"
        ;;
    "net")
        LAST="$XDG_CONFIG_HOME/dotfiles/net-last"
        PREFERRED="$XDG_CONFIG_HOME/dotfiles/net-preferred"
        CFG="$2"
        ALL="$HOME/Desktop/VARIA/networks/cfg-client-omnitel.sh $HOME/Desktop/VARIA/networks/cfg-client-eth.sh $HOME/Desktop/VARIA/networks/cfg-client-wifi.sh $HOME/Desktop/VARIA/networks/cfg-client-vpnc-ktu-wifi.sh"
        if [ "$CFG" = "none" ]
        then
            CFG="$HOME/Desktop/VARIA/networks/vanilla.sh"
        elif [ "$CFG" = "next" ]
        then
            FOUNDLAST="0"
            for NET in $ALL
            do
                if [ "$FOUNDLAST" = "1" ]
                then
                    CFG="$NET"
                    break
                fi
                if [ "$NET" = "$(cat "$LAST")" ]
                then
                    FOUNDLAST="1"
                fi
            done
            if [ "$CFG" = "next" ]
            then
                if ! [ -e "$PREFERRED" ]
                then
                    echo $HOME/Desktop/VARIA/networks/cfg-client-wifi.sh > "$PREFERRED"
                fi
                if [ "$FOUNDLAST" = "1" ]
                then
                    CFG="${ALL%%.sh*}.sh"
                else
                    CFG="$(cat "$PREFERRED")"
                fi
            fi
        else
            if ! [ -e "$HOME/Desktop/VARIA/networks/cfg-${CFG}.sh" ]
            then
                echo "Error: no such network configuration \"$CFG\" exists" 1>&2
                echo "Available:" 1>&2
                echo "    none"
                ls "$HOME/Desktop/VARIA/networks" | grep "^cfg-" | sed "s/^cfg\-/    /" | sed "s/\\.sh\$//" 1>&2
                exit 1
            fi
            CFG="$HOME/Desktop/VARIA/networks/cfg-${CFG}.sh"
        fi
        echo "$CFG"
        echo "$CFG" > "$LAST"
        echo "$CFG" > "$PREFERRED"
        $HOME/Desktop/VARIA/laptop/rc.power
        $HOME/Desktop/VARIA/laptop/rc.local.start
        $HOME/Desktop/VARIA/laptop/rc.local.modem.stop
        $HOME/Desktop/VARIA/laptop/rc.local.wifi.stop
        nohup $CFG 1>$HOME/.varia/net.log 2>&1 &
        ;;
    "powersave")
        $HOME/Desktop/VARIA/networks/vanilla.sh
        $HOME/Desktop/VARIA/laptop/rc.power
        $HOME/Desktop/VARIA/laptop/rc.local.stop
        $HOME/Desktop/VARIA/laptop/rc.local.modem.stop
        $HOME/Desktop/VARIA/laptop/rc.local.wifi.stop
        rm -f "$LAST"
        ;;
    "reboot" | "restart")
        $HOME/Desktop/VARIA/laptop/rc.local.stop
        $HOME/Desktop/VARIA/laptop/rc.local.modem.stop
        $HOME/Desktop/VARIA/laptop/rc.local.wifi.stop
        rm -f "$LAST"
        if which systemctl >/dev/null
        then
            systemctl reboot
        else
            reboot
        fi
        ;;
    "poweroff" | "shutdown")
        $HOME/Desktop/VARIA/laptop/rc.local.stop
        $HOME/Desktop/VARIA/laptop/rc.local.modem.stop
        $HOME/Desktop/VARIA/laptop/rc.local.wifi.stop
        rm -f "$LAST"
        if which systemctl >/dev/null
        then
            systemctl poweroff
        else
            poweroff
        fi
        ;;
    "suspend")
        $HOME/bin/switch-display LVDS1
        $HOME/Desktop/VARIA/laptop/rc.local.stop
        $HOME/Desktop/VARIA/laptop/rc.local.modem.stop
        $HOME/Desktop/VARIA/laptop/rc.local.wifi.stop
        rm -f "$LAST"
        if which systemctl >/dev/null
        then
            systemctl suspend
        else
            pm-suspend
        fi
        xrandr --auto
        $HOME/bin/update-xinput
        $HOME/Desktop/VARIA/laptop/rc.power
        ;;
    "hibernate")
        $HOME/bin/switch-display LVDS1
        $HOME/Desktop/VARIA/laptop/rc.local.stop
        $HOME/Desktop/VARIA/laptop/rc.local.modem.stop
        $HOME/Desktop/VARIA/laptop/rc.local.wifi.stop
        rm -f "$LAST"
        if which systemctl >/dev/null
        then
            systemctl hibernate
        else
            pm-hibernate
        fi
        xrandr --auto
        $HOME/bin/update-xinput
        $HOME/Desktop/VARIA/laptop/rc.power
        ;;
    "help")
        help
        ;;
    *)
        echo "Error: unknown command given" 1>&2
        help 1>&2
        exit 1
        ;;
esac
