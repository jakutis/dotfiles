#!/usr/bin/env bash

if [ "$(id -u)" != "0" ]
then
  sudo $0 "$@"
  exit
fi

CMD="$1"

function help {
    echo "Available commands: help hibernate poweroff reboot net powersave"
}

if [ -z "$CMD" ]
then
    echo "Error: no command given" 1>&2
    help 1>&2
    exit 1
fi

LAST="/home/tahu/.varia/net-last"
PREFERRED="/home/tahu/.varia/net-preferred"

case "$CMD" in
    "net")
        CFG="$2"
        #ALL="$(ls /home/tahu/Desktop/VARIA/networks/cfg-*.sh)"
        ALL="/home/tahu/Desktop/VARIA/networks/cfg-client-omnitel.sh /home/tahu/Desktop/VARIA/networks/cfg-client-eth.sh /home/tahu/Desktop/VARIA/networks/cfg-client-wifi.sh /home/tahu/Desktop/VARIA/networks/cfg-client-vpnc-ktu-wifi.sh"
        if [ "$CFG" = "next" ]
        then
            FOUNDLAST="0"
            for NET in $ALL
            do
                if [ "$FOUNDLAST" = "1" ]
                then
                    CFG="$NET"
                    break
                fi
                if [ "$NET" = "$(cat "$LAST")" ]
                then
                    FOUNDLAST="1"
                fi
            done
            if [ "$CFG" = "next" ]
            then
                if ! [ -e "$PREFERRED" ]
                then
                    echo /home/tahu/Desktop/VARIA/networks/cfg-client-wifi.sh > "$PREFERRED"
                fi
                if [ "$FOUNDLAST" = "1" ]
                then
                    CFG="${ALL%%.sh*}.sh"
                else
                    CFG="$(cat "$PREFERRED")"
                fi
            fi
        else
            if ! [ -e "/home/tahu/Desktop/VARIA/networks/cfg-${CFG}.sh" ]
            then
                echo "Error: no such network configuration \"$CFG\" exists" 1>&2
                echo "Available:" 1>&2
                ls "/home/tahu/Desktop/VARIA/networks" | grep "^cfg-" | sed "s/^cfg\-/    /" | sed "s/\\.sh\$//" 1>&2
                exit 1
            fi
            CFG="/home/tahu/Desktop/VARIA/networks/cfg-${CFG}.sh"
        fi
        echo "$CFG"
        echo "$CFG" > "$LAST"
        echo "$CFG" > "$PREFERRED"
        /home/tahu/Desktop/VARIA/laptop/rc.local.start
        /home/tahu/Desktop/VARIA/laptop/rc.local.modem.stop
        /home/tahu/Desktop/VARIA/laptop/rc.local.wifi.stop
        nohup $CFG 1>/home/tahu/.varia/net.log 2>&1 &
        ;;
    "powersave")
        /home/tahu/Desktop/VARIA/laptop/rc.local.stop
        /home/tahu/Desktop/VARIA/laptop/rc.local.modem.stop
        /home/tahu/Desktop/VARIA/laptop/rc.local.wifi.stop
        rm "$LAST"
        ;;
    "reboot" | "restart")
        /home/tahu/Desktop/VARIA/laptop/rc.local.stop
        /home/tahu/Desktop/VARIA/laptop/rc.local.modem.stop
        /home/tahu/Desktop/VARIA/laptop/rc.local.wifi.stop
        rm "$LAST"
        systemctl reboot
        ;;
    "poweroff" | "shutdown")
        /home/tahu/Desktop/VARIA/laptop/rc.local.stop
        /home/tahu/Desktop/VARIA/laptop/rc.local.modem.stop
        /home/tahu/Desktop/VARIA/laptop/rc.local.wifi.stop
        rm "$LAST"
        systemctl poweroff
        ;;
    "suspend")
        switch-display LVDS1
        /home/tahu/Desktop/VARIA/laptop/rc.local.stop
        /home/tahu/Desktop/VARIA/laptop/rc.local.modem.stop
        /home/tahu/Desktop/VARIA/laptop/rc.local.wifi.stop
        rm "$LAST"
        systemctl suspend
        xrandr --auto
        ;;
    "hibernate")
        switch-display LVDS1
        /home/tahu/Desktop/VARIA/laptop/rc.local.stop
        /home/tahu/Desktop/VARIA/laptop/rc.local.modem.stop
        /home/tahu/Desktop/VARIA/laptop/rc.local.wifi.stop
        rm "$LAST"
        systemctl hibernate
        xrandr --auto
        su -c "pulseaudio -n --system --disallow-module-loading --disallow-exit --realtime --load=module-device-restore --load=module-stream-restore --load=module-card-restore --load=module-alsa-sink --load=module-alsa-source --load=module-native-protocol-unix --daemon"
        ;;
    "help")
        help
        ;;
    *)
        echo "Error: unknown command given" 1>&2
        help 1>&2
        exit 1
        ;;
esac
