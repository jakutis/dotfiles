#!/usr/bin/env bash

if [ -z "$(which pdftk 2>/dev/null)" ]
then
    echo "Please install pdftk"
    exit 1
fi

if [ -z "$(which convert 2>/dev/null)" ]
then
    echo "Please install ImageMagick"
    exit 1
fi

if [ -z "$1" ]
then
  echo "please supply target pdf filename"
  exit 1
fi

OPTS=""
if [ -n "$2" ]
then
  OPTS="$2"
fi

PDFS=()
while read FILE
do
  if [ "$FILE" = ".." ]
  then
    continue
  fi
  if [ "$FILE" = "." ]
  then
    continue
  fi
  echo "$FILE"
  convert "$FILE" $OPTS "$FILE.jpg"
  convert "$FILE.jpg" "$FILE.pdf"
  rm "$FILE.jpg"
  PDFS+=("${FILE}.pdf")
done

pdftk "${PDFS[@]}" cat output "$1"
rm "${PDFS[@]}"
