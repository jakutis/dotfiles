#!/usr/bin/env bash

DIR="$1"
URL="$2"

cd "$DIR" || exit 1
LATEST=$(cat .latest 2>/dev/null || echo 0)

youtube-dl --dump-json --flat-playlist "$URL" 2>/dev/null | jq --slurp --compact-output "sort_by(.timestamp) | .[]" | while read -r ITEM
do
  TIMESTAMP="$(echo "$ITEM" | jq --raw-output .timestamp)"
  if [ "$LATEST" != "0" -a "$TIMESTAMP" -gt "$LATEST" ]
  then
    TITLE="$(echo "$ITEM" | jq --raw-output .title)"
    URL="$(echo "$ITEM" | jq --raw-output .url)"
    EXTENSION="${URL%\?*}"
    EXTENSION="${EXTENSION##*.}"
    FILENAME="$(echo "$TIMESTAMP-$TITLE.$EXTENSION" | inline-detox)"
    echo "downloading $FILENAME"
    curl --fail --location --progress-bar "$URL" > "$FILENAME.part" && id3v2 --delete-all "$FILENAME.part" 1>/dev/null && id3v2 --artist "$DIR" --album "$DIR" --song "$DIR-$(date -Idate -d "@$TIMESTAMP" | cut -c6-10)-$TITLE" "$FILENAME.part" && mv "$FILENAME.part" "$FILENAME" || exit 1
  fi

  if [ "$(cat .latest 2>/dev/null || echo 0)" -lt "$TIMESTAMP" ]
  then
    rm -f .latest && echo "$TIMESTAMP" > .latest
  fi
done

echo "$DIR downloaded"
