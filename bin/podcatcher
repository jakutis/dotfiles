#!/usr/bin/env bash

DIR="$1"
URL="$2"
LOGFILE="$3"

cd "$DIR" || exit 1
LATEST=$(cat .latest 2>/dev/null || echo 0)

curl --fail --location --progress-bar "$URL" | convertfeed | jq --compact-output "sort_by(.pubdate) | .[]" | while read -r ITEM
do
  TIMESTAMP="$(echo "$ITEM" | jq --raw-output .pubdate)"
  if [ "$LATEST" != "0" -a "$TIMESTAMP" -gt "$LATEST" ]
  then
    TITLE="$(echo "$ITEM" | jq --raw-output .title)"
    URL="$(echo "$ITEM" | jq --raw-output '.enclosures[0].url')"
    if [ "$URL" == "null" ]
    then
      URL="$(echo "$ITEM" | jq --raw-output .link)"
    fi
    SONG="$DIR-$(date -Idate -d "@$TIMESTAMP" | cut -c6-10)-$(date -Idate -d "@$TIMESTAMP" | cut -c1-4)-$TITLE"
    BASEFILENAME="$(echo "$SONG-$TIMESTAMP" | inline-detox)"

    echo "downloading $BASEFILENAME"
    DOWNLOAD=$(youtube-dl --audio-quality 0 --audio-format best --extract-audio --print-json "$URL" 2>/dev/null) || exit 1
    _FILENAME="$(echo "$DOWNLOAD" | jq --raw-output ._filename)"
    EXTENSION="$(echo "$DOWNLOAD" | jq --raw-output .ext)"
    FILENAME="$BASEFILENAME.$EXTENSION"
    MP3FILENAME="$BASEFILENAME.mp3"

    mv "$_FILENAME" "$FILENAME" || exit 1
    if [ "$FILENAME" != "$MP3FILENAME" ]
    then
      mp3 "$FILENAME" 1>/dev/null && rm "$FILENAME" || exit 1
    fi
    id3v2 --delete-all "$MP3FILENAME" 1>/dev/null && id3v2 --artist "$DIR" --album "$DIR" --song "$SONG" "$MP3FILENAME" || exit 1
    touch -m --date="$(date --rfc-3339=ns -d "@$TIMESTAMP")" "$MP3FILENAME" || exit 1

    if [ -n "$LOGFILE" ]
    then
      echo "$BASEFILENAME" >> "$LOGFILE"
    fi
  fi

  if [ "$(cat .latest 2>/dev/null || echo 0)" -lt "$TIMESTAMP" ]
  then
    rm -f .latest && echo "$TIMESTAMP" > .latest
  fi
done || exit 1

echo "$DIR downloaded"
