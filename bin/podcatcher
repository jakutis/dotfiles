#!/usr/bin/env bash

DIR="$1"
URL="$2"

cd "$DIR" || exit 1
LATEST=$(cat .latest)

youtube-dl -j --flat-playlist "$URL" 2>/dev/null | jq --compact-output "select(.timestamp >= $LATEST)" | while read ITEM
do
  TIMESTAMP="$(echo "$ITEM" | jq --raw-output .timestamp)"
  if [ "$TIMESTAMP" -gt "$LATEST" ]
  then
    TITLE="$(echo "$ITEM" | jq --raw-output .title)"
    URL="$(echo "$ITEM" | jq --raw-output .url)"
    EXTENSION="${URL##*.}"
    FILENAME="$(echo "$TIMESTAMP-$TITLE.$EXTENSION" | inline-detox)"
    wget -O "$FILENAME" "$URL" || exit 1
  fi

  if [ "$(cat .latest)" -lt "$TIMESTAMP" ]
  then
    rm .latest && echo "$TIMESTAMP" > .latest
  fi
done
