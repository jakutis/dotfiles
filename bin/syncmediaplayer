#!/usr/bin/env bash

CFG="$HOME/.mediaplayer"

if ! [ -e "$CFG" ]
then
    echo "Please create a config file "$CFG""
    echo "Example:"
    echo "MUS /albums-flac/1957 - Ella Fitzgerald, Billie Holiday, And Carmen McRae at Newport"
    echo "POD /podcasts/somafm"
    echo "MUS /albums-flac/Wild Nothing - Nocturne (2012) [FLAC]"
    exit 1
fi

DAYS="$1"
if [ -z "$DAYS" ]
then
    echo "Error: please specify a number of days old tracks should not be copied" >&2
    exit 1
fi

NAME="$2"
if [ -z "$NAME" ]
then
    echo "Error: please specify the media player name (must be mounted on /mnt/<name>)" >&2
    exit 1
fi

SOURCE="$3"
if [ -z "$SOURCE" ]
then
    echo "Error: please specify the root directory of files" >&2
    exit 1
fi

if ! [ -d "$SOURCE" ]
then
    echo "Error: the specified root directory of files does not exist: $SOURCE"
    exit 1
fi

mymount "$NAME" || exit 1

cat "$CFG" | (
while read ITEM
do
    echo $ITEM

    DIR="${ITEM:4}"
    TYPE="${ITEM:0:3}"
    BASENAME="/$(basename "$DIR")"
    if [ "$TYPE" = "MUS" ]
    then
        TARGET="/MUSIC"
    elif [ "$TYPE" = "POD" ]
    then
        TARGET="/MUSIC/PODCASTS"
    fi

    if ! [ -d "$SOURCE$DIR" ]
    then
        echo "A source directory $SOURCE$DIR does not exist"
        exit 1
    fi

    cd "$SOURCE$DIR"

    /usr/bin/find . -mtime "-$DAYS" | (while read FILE
    do
        if [ -d "$FILE" ]
        then
            /bin/mkdir -p "/mnt/$NAME$TARGET$BASENAME/$FILE"
        elif [ -f "$FILE" ]
        then
            /bin/cp -uv "$FILE" "/mnt/$NAME$TARGET$BASENAME/$FILE"
        fi
    done)
done
mymount "$NAME"
)

