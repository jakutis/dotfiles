#!/usr/bin/env bash

PYTHONV="2.7.3"
QPDFVIEWV="0.3.7"
GHCV="7.4.2"
NEWSBEUTERV="2.5"
MOSHV="1.2.3"
HASKELLPLATFORMV="2012.4.0.0"
NODEV="0.8.18"
ERLANGV="R15B03"
RTORRENTV="0.9.2"
LIBTORRENTV="0.13.2"
PODCATCHERV="3.1.6"
PODCATCHERURL="http://rubyforge.org/frs/download.php/76053/podcatcher-3.1.6.tar.gz"
MCABBERV="0.10.2"
SVG2PDFV="301dd48"

DOTFILES="$(realpath "$1")"
VARIA="$(realpath "$2")"

if ! [ -e "$DOTFILES" ]
then
    echo "DOTFILES at "$DOTFILES" does not exist" 1>&2
    exit 1
fi
if ! [ -e "$VARIA" ]
then
    echo "VARIA at "$VARIA" does not exist" 1>&2
    exit 1
fi

cd "$HOME"

mkdir -p ".local/share/applications"
cd ".local/share/applications"
for APP in www qpdfview
do
    ln -nsf "$DOTFILES/applications/$APP.desktop"
done
ln -nsf "$DOTFILES/mimeapps.list"
ln -nsf "mimeapps.list" "defaults.list"
cd "$HOME"

mkdir -p ".bin"
ln -nsf "$VARIA/gitac" ".bin/gitac"
ln -nsf "$VARIA/gitD" ".bin/gitD"

mkdir -p Downloads/rtorrent
mkdir -p Downloads/rygel/music
mkdir -p Downloads/rygel/video
mkdir -p Downloads/rygel/pictures
mkdir -p .rtorrent.session

mkdir -p ".newsbeuter"
cd ".newsbeuter"
ln -nsf "$DOTFILES/.newsbeuter/config"
ln -nsf "$VARIA/news.txt" urls
cd ..

for RC in bin .gitconfig .bashrc .profile .bash_aliases .jshintrc .hgrc .xinitrc .Xresources .Xmodmap .dircolors .inputrc .mailcap .muttrc .termcap .xbindkeysrc .vimrc .rtorrent.rc
do
    ln -nsf "$DOTFILES/$RC"
done

mkdir -p .vimtmp .vimbackup
if ! [ -e ".vim" ]
then
    git clone https://github.com/gmarik/vundle.git .vim/bundle/vundle
    vim +BundleInstall +qall
fi

if ! [ -e ".bin/kerl" ]
then
    curl -O https://raw.github.com/spawngrid/kerl/master/kerl
    chmod +x kerl
    mv kerl .bin
    kerl build "$ERLANGV" "$ERLANGV"
    kerl install "$ERLANGV" "$HOME/opt/erlang-$ERLANGV"
    cd opt
    ln -nsf "erlang-$ERLANGV" "erlang"
    cd ..
fi

if ! [ -e ".nvm" ]
then
    git clone https://github.com/creationix/nvm .nvm
    source .nvm/nvm.sh
    ln -nsf "$DOTFILES/.nodepackages"
    "$DOTFILES/bin/nodeup" "$NODEV"
fi

if ! [ -e ".rvm" ]
then
    curl -L https://get.rvm.io | rvm_path="$HOME/.rvm" bash -s stable --ruby
    source .rvm/scripts/rvm
    gem install jekyll rdiscount
fi

install-user-rygel || exit 1

if ! [ -e "opt/podcatcher-$PODCATCHERV" ]
then
    curl -L "$PODCATCHERURL" | tar zxf -
    mv podcatcher opt/podcatcher-$PODCATCHERV
    cd opt
    ln -nsf podcatcher-$PODCATCHERV podcatcher
    cd ../.bin
    ln -nsf ../opt/podcatcher/bin/podcatcher
    cd ..
fi

if ! [ -e ".pythonbrew" ]
then
    export PYTHONBREW_ROOT=$HOME/.pythonbrew
    curl -kL http://xrl.us/pythonbrewinstall | bash
    source .pythonbrew/etc/bashrc
    pythonbrew install "$PYTHONV"
    pythonbrew switch "$PYTHONV"
fi

if ! [ -e "opt/ghc-$GHCV" ]
then
    wget http://www.haskell.org/ghc/dist/$GHCV/ghc-$GHCV-$(uname -m)-unknown-linux.tar.bz2
    tar xf ghc-$GHCV-$(uname -m)-unknown-linux.tar.bz2
    cd ghc-$GHCV
    ./configure --prefix="$HOME/opt/ghc-$GHCV" && make install
    cd ../opt
    ln -nsf ghc-$GHCV ghc
    cd ..
    rm -rf ghc-$GHCV-$(uname -m)-unknown-linux.tar.bz2 ghc-$GHCV
fi

if ! [ -e "opt/haskell-platform-$HASKELLPLATFORMV" ]
then
    wget http://lambda.haskell.org/platform/download/$HASKELLPLATFORMV/haskell-platform-$HASKELLPLATFORMV.tar.gz
    tar xf haskell-platform-$HASKELLPLATFORMV.tar.gz
    cd haskell-platform-$HASKELLPLATFORMV
    ./configure --prefix="$HOME/opt/haskell-platform-$HASKELLPLATFORMV"
    make && make install
    cd ../opt
    ln -nsf haskell-platform-$HASKELLPLATFORMV haskell-platform
    cabal update
    cd ..
    rm -rf haskell-platform-$HASKELLPLATFORMV.tar.gz haskell-platform-$HASKELLPLATFORMV
fi

if ! [ -e "opt/mosh-$MOSHV" ]
then
    wget https://github.com/downloads/keithw/mosh/mosh-$MOSHV.tar.gz
    tar xf mosh-$MOSHV.tar.gz
    cd mosh-$MOSHV
    ./configure --prefix=$HOME/opt/mosh-$MOSHV
    make && make install
    cd ../opt
    ln -nsf mosh-$MOSHV mosh
    cd ..
    rm -rf mosh-$MOSHV mosh-$MOSHV.tar.gz
fi

if ! [ -e "opt/newsbeuter-$NEWSBEUTERV" ]
then
    wget http://www.newsbeuter.org/downloads/newsbeuter-$NEWSBEUTERV.tar.gz
    tar xf newsbeuter-$NEWSBEUTERV.tar.gz
    cd newsbeuter-$NEWSBEUTERV
echo "
diff -ru a/src/controller.cpp b/src/controller.cpp
--- a/src/controller.cpp	2012-01-06 16:41:13.000000000 +0200
+++ b/src/controller.cpp	2013-01-02 15:32:58.935471087 +0200
@@ -1,3 +1,4 @@
+#include <unistd.h>
 #include <config.h>
 #include <view.h>
 #include <controller.h>
diff -ru a/src/google_api.cpp b/src/google_api.cpp
--- a/src/google_api.cpp	2012-01-06 16:41:13.000000000 +0200
+++ b/src/google_api.cpp	2013-01-02 15:32:37.378796594 +0200
@@ -1,3 +1,4 @@
+#include <unistd.h>
 #include <vector>
 #include <cstring>
 #include <iostream>
diff -ru a/src/pb_controller.cpp b/src/pb_controller.cpp
--- a/src/pb_controller.cpp	2012-01-06 16:41:13.000000000 +0200
+++ b/src/pb_controller.cpp	2013-01-02 15:32:25.912134360 +0200
@@ -1,3 +1,4 @@
+#include <unistd.h>
 #include <pb_controller.h>
 #include <pb_view.h>
 #include <poddlthread.h>
diff -ru a/src/queueloader.cpp b/src/queueloader.cpp
--- a/src/queueloader.cpp	2012-01-06 16:41:13.000000000 +0200
+++ b/src/queueloader.cpp	2013-01-02 15:32:14.942135309 +0200
@@ -1,3 +1,4 @@
+#include <unistd.h>
 #include <stflpp.h>
 #include <utils.h>
 #include <queueloader.h>
diff -ru a/src/reloadthread.cpp b/src/reloadthread.cpp
--- a/src/reloadthread.cpp	2012-01-06 16:41:13.000000000 +0200
+++ b/src/reloadthread.cpp	2013-01-02 15:32:48.212132179 +0200
@@ -1,3 +1,4 @@
+#include <unistd.h>
 #include <reloadthread.h>
 #include <logger.h>

diff -ru a/src/utils.cpp b/src/utils.cpp
--- a/src/utils.cpp	2012-01-06 16:41:13.000000000 +0200
+++ b/src/utils.cpp	2013-01-02 15:33:07.515464038 +0200
@@ -1,3 +1,4 @@
+#include <unistd.h>
 #include <utils.h>
 #include <logger.h>
 #include <config.h>
 " | patch -p1
    ./config.sh
    make prefix=$HOME/opt/newsbeuter-$NEWSBEUTERV && make prefix=$HOME/opt/newsbeuter-$NEWSBEUTERV install
    cd ../opt
    ln -nsf newsbeuter-$NEWSBEUTERV newsbeuter
    rm -rf ../newsbeuter-$NEWSBEUTERV ../newsbeuter-$NEWSBEUTERV.tar.gz
    cd ../.bin
    ln -nsf ../opt/newsbeuter/bin/newsbeuter
    cd ..
fi

if ! [ -e "opt/qpdfview-$QPDFVIEWV" ]
then
    wget "https://launchpad.net/qpdfview/trunk/$QPDFVIEWV/+download/qpdfview-$QPDFVIEWV.tar.gz"
    tar xf "qpdfview-$QPDFVIEWV.tar.gz"
    cd "qpdfview-$QPDFVIEWV"
    qmake && make && make INSTALL_ROOT=$HOME/opt/qpdfview-$QPDFVIEWV install
    cd ../opt
    ln -nsf qpdfview-$QPDFVIEWV qpdfview
    cd ..
    rm -rf qpdfview-$QPDFVIEWV.tar.gz qpdfview-$QPDFVIEWV
fi

if ! [ -e "opt/mcabber-$MCABBERV" ]
then
    curl -L "http://mcabber.com/files/mcabber-${MCABBERV}.tar.bz2" | tar jxf -
    cd mcabber-$MCABBERV
    ./configure --prefix=$HOME/opt/mcabber-$MCABBERV && make && make install
    cd ../opt
    ln -nsf mcabber-$MCABBERV mcabber
    cd ../.bin
    ln -nsf ../opt/mcabber/bin/mcabber
    cd ..
    rm -rf mcabber-$MCABBERV
fi

if ! [ -e "opt/rtorrent-$RTORRENTV" ]
then
    wget "http://libtorrent.rakshasa.no/downloads/libtorrent-${LIBTORRENTV}.tar.gz" -O - | tar zxf -
    wget "http://libtorrent.rakshasa.no/downloads/rtorrent-${RTORRENTV}.tar.gz" -O - | tar zxf -
    cd libtorrent-${LIBTORRENTV}
    ./configure --prefix=$HOME/opt/rtorrent-$RTORRENTV && make && make install
    cd ../rtorrent-${RTORRENTV}
    PKG_CONFIG_PATH=$HOME/opt/rtorrent-$RTORRENTV/lib/pkgconfig ./configure --prefix=$HOME/opt/rtorrent-$RTORRENTV && make && make install
    cd ../opt
    ln -nsf rtorrent-$RTORRENTV rtorrent
    cd ..
    rm -rf rtorrent-${RTORRENTV} libtorrent-${LIBTORRENTV}
    cd .bin
    ln -nsf ../opt/rtorrent/bin/rtorrent
    cd ..
fi

if ! [ -e "opt/svg2pdf-$SVG2PDFV" ]
then
    git clone git://people.freedesktop.org/~cworth/svg2pdf || exit 1
    cd svg2pdf
    git co "$SVG2PDFV"
    make || exit 1
    mkdir "../opt/svg2pdf-$SVG2PDFV"
    cp svg2pdf "../opt/svg2pdf-$SVG2PDFV"
    cd ../opt
    ln -nsf "svg2pdf-$SVG2PDFV" svg2pdf
    cd ../.bin
    ln -nsf "../opt/svg2pdf-$SVG2PDFV/svg2pdf"
    cd ..
    rm -rf "svg2pdf"
fi

if ! [ -e ".bin/sfnt2woff" -a -e ".bin/woff2sfnt" ]
then
    mkdir sfnt2woff
    cd sfnt2woff
    wget http://people.mozilla.com/~jkew/woff/woff-code-latest.zip
    unzip woff-code-latest.zip
    make
    cp woff2sfnt ../.bin
    cp sfnt2woff ../.bin
    cd ..
    rm -rf sfnt2woff
fi
