#!/usr/bin/env bash

PYTHONV="2.7.3"
GHCV="7.4.2"
NEWSBEUTERV="2.5"
MOSHV="1.2.3"
HASKELLPLATFORMV="2012.4.0.0"
NODEV="0.8.16"
ERLANGV="R15B03"

DOTFILES="$(realpath "$1")"
VARIA="$(realpath "$2")"

if ! [ -e "$DOTFILES" ]
then
    echo "DOTFILES at "$DOTFILES" does not exist" 1>&2
    exit 1
fi
if ! [ -e "$VARIA" ]
then
    echo "VARIA at "$VARIA" does not exist" 1>&2
    exit 1
fi

mkdir -p "$HOME/.local/share/applications"
cd "$HOME/.local/share/applications"

for APP in www qpdfview
do
    rm "$APP.desktop"
    ln -s "$DOTFILES/applications/$APP.desktop"
done

rm "mimeapps.list"
ln -s "$DOTFILES/mimeapps.list"
rm "defaults.list"
ln -s "mimeapps.list" "defaults.list"

cd "$HOME"
mkdir -p ".bin"

mkdir -p ".newsbeuter"
cd ".newsbeuter"
rm "config"
ln -s "$DOTFILES/.newsbeuter/config"
rm "urls"
ln -s "$VARIA/news.txt" urls
cd ..

for RC in bin .gitconfig .bashrc .profile .bash_aliases .jshintrc .hgrc .xinitrc .Xresources .Xmodmap .dircolors .inputrc .mailcap .muttrc .termcap .signature .xbindkeysrc .vimrc
do
    rm "$RC"
    ln -s "$DOTFILES/$RC"
done

mkdir -p .vimtmp .vimbackup
if ! [ -e ".vim" ]
then
    git clone https://github.com/gmarik/vundle.git .vim/bundle/vundle
    vim +BundleInstall +qall
fi

if ! [ -e ".bin/kerl" ]
then
    curl -O https://raw.github.com/spawngrid/kerl/master/kerl
    chmod +x kerl
    mv kerl .bin
    kerl build "$ERLANGV" "$ERLANGV"
    kerl install "$ERLANGV" "$HOME/opt/erlang-$ERLANGV"
    cd opt
    ln -s "erlang-$ERLANGV" "erlang"
    cd ..
fi

if ! [ -e ".nvm" ]
then
    git clone https://github.com/creationix/nvm .nvm
    source .nvm/nvm.sh
    ln -s "$DOTFILES/.nodepackages"
    nodeup "$NODEV"
fi

if ! [ -e ".rvm" ]
then
    curl -L https://get.rvm.io | bash -s stable --ruby
    source .rvm/scripts/rvm
    gem install jekyll rdiscount
fi

if ! [ -e ".pythonbrew" ]
then
    curl -kL http://xrl.us/pythonbrewinstall | bash
    source .pythonbrew/etc/bashrc
    pythonbrew install "$PYTHONV"
    pythonbrew switch "$PYTHONV"
fi

if ! [ -e "opt/ghc" ]
then
    wget http://www.haskell.org/ghc/dist/$GHCV/ghc-$GHCV-$(uname -m)-unknown-linux.tar.bz2
    tar xf ghc-$GHCV-$(uname -m)-unknown-linux.tar.bz2
    cd ghc-$GHCV
    ./configure --prefix="$HOME/opt/ghc-$GHCV" && make install
    cd ../opt
    ln -s ghc-$GHCV ghc
    cd ..
fi

if ! [ -e "opt/haskell-platform" ]
then
    wget http://lambda.haskell.org/platform/download/$HASKELLPLATFORMV/haskell-platform-$HASKELLPLATFORMV.tar.gz
    tar xf haskell-platform-$HASKELLPLATFORMV.tar.gz
    cd haskell-platform-$HASKELLPLATFORMV
    ./configure --prefix="$HOME/opt/haskell-platform-$HASKELLPLATFORMV"
    make && make install
    cd ../opt
    ln -s haskell-platform-$HASKELLPLATFORMV haskell-platform
    cabal update
    cd ..
fi

if ! [ -e "$HOME/opt/mosh-$MOSHV" ]
then
    cd "$HOME"
    wget https://github.com/downloads/keithw/mosh/mosh-$MOSHV.tar.gz
    tar xf mosh-$MOSHV.tar.gz
    cd mosh-$MOSHV
    ./configure --prefix=$HOME/opt/mosh-$MOSHV
    make && make install
    cd ../opt
    ln -s mosh-$MOSHV mosh
    rm -rf ../mosh-$MOSHV ../mosh-$MOSHV.tar.gz
fi

if ! [ -e "$HOME/opt/newsbeuter-$NEWSBEUTERV" ]
then
    cd "$HOME"
    wget http://www.newsbeuter.org/downloads/newsbeuter-$NEWSBEUTERV.tar.gz
    tar xf newsbeuter-$NEWSBEUTERV.tar.gz
    cd newsbeuter-$NEWSBEUTERV
    ./config.sh
    make prefix=$HOME/opt/newsbeuter-$NEWSBEUTERV && make prefix=$HOME/opt/newsbeuter-$NEWSBEUTERV install
    cd ../opt
    rm newsbeuter
    ln -s newsbeuter-$NEWSBEUTERV newsbeuter
    rm -rf ../newsbeuter-$NEWSBEUTERV ../newsbeuter-$NEWSBEUTERV.tar.gz
    cd ../.bin
    ln -s ../opt/newsbeuter/bin/newsbeuter
fi
