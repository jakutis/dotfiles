#!/usr/bin/env bash

ANTV="1.9.2"
NZBGETV="11.0"
PYTHONV="2.7.3"
QPDFVIEWV="0.4.7"
QPDFVIEWR="qpdfview-$QPDFVIEWV"
GHCV="7.6.3"
CABALINSTALLV="1.18.0.2"
NEWSBEUTERV="2.7"
MOSHV="1.2.4"
NODEV="0.10.24"
ERLANGV="R16B02"
RTORRENTV="0.9.3"
LIBTORRENTV="0.13.3"
PODCATCHERV="3.1.6"
PODCATCHERURL="http://rubyforge.org/frs/download.php/76053/podcatcher-3.1.6.tar.gz"
MCABBERV="0.10.2"
SVG2PDFV="301dd48"
RMV="3"
RV="${RMV}.0.2"
GOV="1.2"
YOUTUBEDLV="2013.12.17.2"
VIMV="v7-4-009"
COLOROUTV="1.0-1"
TMUXV="1.8"
LIBEVENTV="2.0.21"
ELINKSV="a229adb"
IMAGEMAGICKV="6.8.6-9"
CMUSV="2.5.0"

DOTFILES="$(realpath "$1")"
VARIA="$(realpath "$2")"

if ! [ -e "$DOTFILES" ]
then
    echo "DOTFILES at "$DOTFILES" does not exist" 1>&2
    exit 1
fi
if ! [ -e "$VARIA" ]
then
    echo "VARIA at "$VARIA" does not exist" 1>&2
    exit 1
fi

cd "$HOME"

mkdir -p ".local/share/applications"
cd ".local/share/applications"
for APP in www qpdfview
do
    ln -nsf "$DOTFILES/applications/$APP.desktop"
done
ln -nsf "$DOTFILES/mimeapps.list"
ln -nsf "mimeapps.list" "defaults.list"
cd "$HOME"

mkdir -p "opt"

mkdir -p ".bin"
ln -nsf "$VARIA/gitac" ".bin/gitac"
ln -nsf "$VARIA/gitacAll" ".bin/gitacAll"
ln -nsf "$VARIA/gitD" ".bin/gitD"

mkdir -p Downloads/rtorrent
mkdir -p .rtorrent.session

mkdir -p ".config/newsbeuter"
cd ".config/newsbeuter"
ln -nsf "$DOTFILES/.newsbeuter/config"
ln -nsf "$VARIA/news.txt" urls
cd ../..

mkdir -p ".cmus"
cd ".cmus"
ln -nsf "$DOTFILES/.cmus/rc"
cd ..

mkdir -p ".elinks"
cd ".elinks"
ln -nsf "$DOTFILES/.elinks/elinks.conf"
cd ..

for RC in bin .gitconfig .bashrc .profile .bash_aliases .jshintrc .hgrc .Xresources .Xmodmap .dircolors .inputrc .mailcap .muttrc .termcap .xbindkeysrc .vimrc .rtorrent.rc .fonts.conf.d .tmux.conf
do
    ln -nsf "$DOTFILES/$RC"
done

if [ "$(hostname)" = "server" ]
then
    ln -nsf "$DOTFILES/.xinitrc.server" ".xinitrc"
else
    ln -nsf "$DOTFILES/.xinitrc"
fi

if [ "$(hostname)" = "desktop" ]
then
    mkdir --parents .recoll
    cd .recoll
    ln -nsf "$VARIA/desktop/recoll.conf"
    cd ..
fi

mkdir -p .config
cd .config
ln -nsf "$DOTFILES/.config/awesome"
cd ..

if ! [ -e ".varia/desktop" ]
then
    cd .varia
    ln -nsf "$VARIA/desktop"
    cd ..
fi

if ! [ -e ".bin/kerl" ]
then
    curl -O https://raw.github.com/spawngrid/kerl/master/kerl
    chmod +x kerl
    mv kerl .bin
    kerl update releases
    kerl build "$ERLANGV" "$ERLANGV"
    kerl install "$ERLANGV" "$HOME/opt/erlang-$ERLANGV"
    cd opt
    ln -nsf "erlang-$ERLANGV" "erlang"
    cd ..
fi

if ! [ -e ".nvm" ]
then
    git clone https://github.com/creationix/nvm .nvm
    source .nvm/nvm.sh
    ln -nsf "$DOTFILES/.nodepackages"
    "$DOTFILES/bin/nodeup" "$NODEV"
fi

if ! [ -e "opt/imagemagick-${IMAGEMAGICKV}" ]
then
    curl -L "http://mirror.checkdomain.de/imagemagick/ImageMagick-${IMAGEMAGICKV}.tar.xz" | tar Jxf - || exit 1
    cd "ImageMagick-${IMAGEMAGICKV}" && ./configure --prefix=${HOME}/opt/imagemagick-${IMAGEMAGICKV} --disable-hdri && make && make install || exit 1
    cd ..
    rm -rf "ImageMagick-${IMAGEMAGICKV}"
    cd opt
    ln -nsf "imagemagick-${IMAGEMAGICKV}" "imagemagick"
    cd ../.bin
    for BIN in $(ls "../opt/imagemagick/bin")
    do
        ln -nsf "../opt/imagemagick/bin/${BIN}"
    done
    cd ..
fi

if ! [ -e ".rvm" ]
then
    curl -L https://get.rvm.io | rvm_path="$HOME/.rvm" bash -s latest-2 stable  --autolibs=read-fail || exit 1
    source .rvm/scripts/rvm
    LDFLAGS="-Wl,--rpath=$HOME/opt/imagemagick/lib,--enable-new-dtags" PKG_CONFIG_PATH="$HOME/opt/imagemagick/lib/pkgconfig" gem install jekyll kramdown pdfbeads rmagick iconv hpricot compass travis-lint || exit 1
fi

if ! [ -e "opt/go-$GOV" ]
then
    curl -L "http://go.googlecode.com/files/go${GOV}.src.tar.gz" | tar zxf -
    mv go "opt/go-$GOV"
    cd "opt/go-$GOV/src"
    ./all.bash || exit 1
    cd ../..
    ln -nsf "go-$GOV" go
    cd ..
fi

if ! [ -e "opt/r-$RV" ]
then
    curl -L "http://stat.ethz.ch/CRAN/src/base/R-$RMV/R-${RV}.tar.gz" | tar zxf - || exit 1
    cd "R-${RV}"
    ./configure --enable-R-shlib --prefix="$HOME/opt/r-$RV" && make && make install || exit 1
    cd ../opt
    ln -s "r-$RV" "r"
    cd ../.bin
    ln -nsf "../opt/r-$RV/bin/R"
    cd ..
    rm -rf "R-${RV}"
    echo 'install.packages(c("correlogram", "ggthemes", "Rserve", "gdata", "knitr", "vimcom", "setwidth", "animation", "rgl", "ggplot2", "memisc"), repos=c("http://cran.us.r-project.org", dependencies=TRUE))' | R --no-save
    wget "http://www.lepem.ufc.br/jaa/colorout_${COLOROUTV}.tar.gz"
    echo "install.packages(c(\"colorout_${COLOROUTV}.tar.gz\"), type=\"source\", repos=NULL)" | R --no-save
    rm colorout_${COLOROUTV}.tar.gz
fi

if ! [ -e "opt/vim-$VIMV" ]
then
    cd "$HOME/repos/hg/vim" || exit 1
    hg checkout "$VIMV" && ./configure --enable-pythoninterp=yes --prefix="$HOME/opt/vim-$VIMV" && make && make install || exit 1
    cd "$HOME/opt"
    ln -nsf "vim-$VIMV" "vim"
    cd ../.bin
    ln -nsf "../opt/vim/bin/vim"
    ln -nsf "../opt/vim/bin/vimdiff"
    cd ..
    rm -rf vim
fi

mkdir -p .vimtmp .vimbackup .vimsession
if ! [ -e ".vim" ]
then
    git clone https://github.com/gmarik/vundle.git .vim/bundle/vundle
    vim +BundleInstall +qall
    cd .vim/bundle/YouCompleteMe/cpp
    cmake -g "Unix Makefiles"
    make
    cd ../../../..
fi

if ! [ -e "opt/js-1.8.5" ]
then
    curl -L "http://ftp.mozilla.org/pub/mozilla.org/js/js185-1.0.0.tar.gz" | tar zx || exit 1
    cd js-1.8.5/js/src && ./configure --prefix="$HOME/opt/js-1.8.5" && make && make install || exit 1
    cd ../../.. && rm -rf js-1.8.5 || exit 1
fi

if ! [ -e "opt/apache-ant-$ANTV" ]
then
    curl -L http://apache.mirror.vu.lt/apache/ant/binaries/apache-ant-$ANTV-bin.tar.bz2 | tar jxf - || exit 1
    mv "apache-ant-$ANTV" opt && cd opt && ln -nsf "apache-ant-$ANTV" "apache-ant" || exit 1
    cd ../.bin && ln -nsf "../opt/apache-ant/bin/ant" || exit 1
    cd ..
fi

if ! [ -e "opt/cmus-$CMUSV" ]
then
    cd "repos/git/cmus" || exit 1
    git co "v$CMUSV" && ./configure CONFIG_MODPLUG=n CONFIG_CDIO=n prefix="$HOME/opt/cmus-$CMUSV" && make && make install || exit 1
    cd ../../../opt && ln -nsf "cmus-$CMUSV" "cmus" || exit 1
    cd ../.bin && ln -nsf "../opt/cmus/bin/cmus" || exit 1
    cd ..
fi

if ! [ -e "opt/elinks-$ELINKSV" ]
then
    git clone git://repo.or.cz/elinks.git && cd elinks && git co $ELINKSV || exit 1
    ./autogen.sh && LDFLAGS="-Wl,--rpath=$HOME/opt/js-1.8.5/lib,--enable-new-dtags" PKG_CONFIG_PATH="$HOME/opt/js-1.8.5/lib/pkgconfig" ./configure --prefix="$HOME/opt/elinks-$ELINKSV" --enable-sm-scripting --without-lua --without-ruby --without-perl --without-python && make && make install || exit 1
    cd .. && rm -rf elinks || exit 1
    cd opt && ln -nsf "elinks-$ELINKSV" elinks || exit 1
    cd ../.bin && ln -nsf "../opt/elinks/bin/elinks" || exit 1
    cd ..
fi

if ! [ -e "opt/youtube-dl-$YOUTUBEDLV" ]
then
    curl -L "http://youtube-dl.org/downloads/$YOUTUBEDLV/youtube-dl" > "opt/youtube-dl-$YOUTUBEDLV"
    chmod +x "opt/youtube-dl-$YOUTUBEDLV"
    cd opt
    ln -nsf "youtube-dl-$YOUTUBEDLV" "youtube-dl"
    cd ../.bin
    ln -nsf "../opt/youtube-dl"
    cd ..
fi

if ! [ -e "opt/libevent-$LIBEVENTV" ]
then
    curl -L "https://github.com/downloads/libevent/libevent/libevent-$LIBEVENTV-stable.tar.gz" | tar zxf -
    cd "libevent-$LIBEVENTV-stable"
    ./configure --prefix="$HOME/opt/libevent-$LIBEVENTV" && make && make install || exit 1
    cd ..
    rm -rf "libevent-$LIBEVENTV-stable"
fi

if ! [ -e "opt/tmux-$TMUXV" ]
then
    curl -L "http://downloads.sourceforge.net/tmux/tmux-${TMUXV}.tar.gz" | tar zxf -
    cd "tmux-$TMUXV"
    LDFLAGS="-Wl,-rpath,$HOME/opt/libevent-$LIBEVENTV/lib" PKG_CONFIG_PATH="$HOME/opt/libevent-$LIBEVENTV/lib/pkgconfig" ./configure --prefix="$HOME/opt/tmux-$TMUXV" && make && make install || exit 1
    cd ..
    rm -rf "tmux-$TMUXV"
    cd opt
    ln -nsf "tmux-$TMUXV" "tmux"
    cd ../.bin
    ln -nsf "../opt/tmux/bin/tmux"
    cd ..
fi

if ! [ -e "opt/nzbget-$NZBGETV" ]
then
    curl -L "http://sourceforge.net/projects/nzbget/files/nzbget-${NZBGETV}.tar.gz" | tar zxf -
    cd "nzbget-${NZBGETV}"
    ./configure --disable-libpar2-bugfixes-check --prefix="$HOME/opt/nzbget-${NZBGETV}" && make && make install || exit 1
    cd ..
    rm -rf "nzbget-${NZBGETV}"
    cd opt
    ln -nsf "nzbget-${NZBGETV}" "nzbget"
    cd ../.bin
    ln -nsf "../opt/nzbget/bin/nzbget"
    cd ..
fi

if ! [ -e "opt/xwinlogger" ]
then
    curl -L "https://github.com/emilis/xwinlogger/archive/master.tar.gz" | tar zxf -
    mkdir -p "opt/xwinlogger/lib" "opt/xwinlogger/bin"
    cd "xwinlogger-master"
    INSTALL_DIR="$HOME/opt/xwinlogger/lib" BIN_DIR="$HOME/opt/xwinlogger/bin" ./install.sh || exit 1
    cd ..
    rm -rf "xwinlogger-master"
    cd .bin
    ln -nsf "../opt/xwinlogger/bin/xwinlogger"
    cd ..
fi

if ! [ -e "opt/podcatcher-$PODCATCHERV" ]
then
    curl -L "$PODCATCHERURL" | tar zxf -
    mv podcatcher opt/podcatcher-$PODCATCHERV
    cd opt
    ln -nsf podcatcher-$PODCATCHERV podcatcher
    cd ../.bin
    ln -nsf ../opt/podcatcher/bin/podcatcher
    cd ..
fi

if ! [ -e ".pythonbrew" ]
then
    export PYTHONBREW_ROOT=$HOME/.pythonbrew
    curl -kL http://xrl.us/pythonbrewinstall | bash
    source .pythonbrew/etc/bashrc
    pythonbrew install "$PYTHONV"
    pythonbrew switch "$PYTHONV"
    for PACKAGE in cython lxml jsbeautifier pygments ocrodjvu python-djvulibre
    do
        pip install "$PACKAGE"
    done
    git clone https://github.com/wetneb/pygments_maple
    cd pygments_maple
    python setup.py install
    cd ..
    rm -rf pygments_maple
fi

if ! [ -e "opt/ghc-$GHCV" ]
then
    curl -L "http://www.haskell.org/ghc/dist/$GHCV/ghc-$GHCV-$(uname -m)-unknown-linux.tar.bz2" | tar jxf - || exit 1
    cd ghc-$GHCV
    ./configure --prefix="$HOME/opt/ghc-$GHCV" && make install || exit 1
    cd ../opt
    ln -nsf ghc-$GHCV ghc
    cd ..
    rm -rf ghc-$GHCV
    rm -rf .cabal .ghc
    curl -L "http://hackage.haskell.org/packages/archive/cabal-install/$CABALINSTALLV/cabal-install-${CABALINSTALLV}.tar.gz" | tar zxf - || exit 1
    cd "cabal-install-${CABALINSTALLV}"
    sh bootstrap.sh && cabal update || exit 1
    for PACKAGE in c2hs git-annex hoogle cabal-dev
    do
        cabal install $PACKAGE || exit 1
    done
    cd ..
    rm -rf "cabal-install-${CABALINSTALLV}"
fi

if ! [ -e "opt/mosh-$MOSHV" ]
then
    wget "http://mosh.mit.edu/mosh-${MOSHV}.tar.gz"
    tar xf mosh-$MOSHV.tar.gz
    cd mosh-$MOSHV
    ./configure --prefix=$HOME/opt/mosh-$MOSHV && make && make install || exit 1
    cd ../opt
    ln -nsf mosh-$MOSHV mosh
    cd ..
    rm -rf mosh-$MOSHV mosh-$MOSHV.tar.gz
fi

if ! [ -e "opt/newsbeuter-$NEWSBEUTERV" ]
then
    wget http://www.newsbeuter.org/downloads/newsbeuter-$NEWSBEUTERV.tar.gz
    tar xf newsbeuter-$NEWSBEUTERV.tar.gz
    cd newsbeuter-$NEWSBEUTERV
echo "
diff -ru a/src/controller.cpp b/src/controller.cpp
--- a/src/controller.cpp	2012-01-06 16:41:13.000000000 +0200
+++ b/src/controller.cpp	2013-01-02 15:32:58.935471087 +0200
@@ -1,3 +1,4 @@
+#include <unistd.h>
 #include <config.h>
 #include <view.h>
 #include <controller.h>
diff -ru a/src/google_api.cpp b/src/google_api.cpp
--- a/src/google_api.cpp	2012-01-06 16:41:13.000000000 +0200
+++ b/src/google_api.cpp	2013-01-02 15:32:37.378796594 +0200
@@ -1,3 +1,4 @@
+#include <unistd.h>
 #include <vector>
 #include <cstring>
 #include <iostream>
diff -ru a/src/pb_controller.cpp b/src/pb_controller.cpp
--- a/src/pb_controller.cpp	2012-01-06 16:41:13.000000000 +0200
+++ b/src/pb_controller.cpp	2013-01-02 15:32:25.912134360 +0200
@@ -1,3 +1,4 @@
+#include <unistd.h>
 #include <pb_controller.h>
 #include <pb_view.h>
 #include <poddlthread.h>
diff -ru a/src/queueloader.cpp b/src/queueloader.cpp
--- a/src/queueloader.cpp	2012-01-06 16:41:13.000000000 +0200
+++ b/src/queueloader.cpp	2013-01-02 15:32:14.942135309 +0200
@@ -1,3 +1,4 @@
+#include <unistd.h>
 #include <stflpp.h>
 #include <utils.h>
 #include <queueloader.h>
diff -ru a/src/reloadthread.cpp b/src/reloadthread.cpp
--- a/src/reloadthread.cpp	2012-01-06 16:41:13.000000000 +0200
+++ b/src/reloadthread.cpp	2013-01-02 15:32:48.212132179 +0200
@@ -1,3 +1,4 @@
+#include <unistd.h>
 #include <reloadthread.h>
 #include <logger.h>

diff -ru a/src/utils.cpp b/src/utils.cpp
--- a/src/utils.cpp	2012-01-06 16:41:13.000000000 +0200
+++ b/src/utils.cpp	2013-01-02 15:33:07.515464038 +0200
@@ -1,3 +1,4 @@
+#include <unistd.h>
 #include <utils.h>
 #include <logger.h>
 #include <config.h>
 " | patch -p1
    ./config.sh
    make prefix=$HOME/opt/newsbeuter-$NEWSBEUTERV && make prefix=$HOME/opt/newsbeuter-$NEWSBEUTERV install
    cd ../opt
    ln -nsf newsbeuter-$NEWSBEUTERV newsbeuter
    rm -rf ../newsbeuter-$NEWSBEUTERV ../newsbeuter-$NEWSBEUTERV.tar.gz
    cd ../.bin
    ln -nsf ../opt/newsbeuter/bin/newsbeuter
    cd ..
fi

if ! [ -e "opt/qpdfview-$QPDFVIEWV" ]
then
    cd "$HOME/repos/bzr/qpdfview" || exit 1
    bzr revert -r "$QPDFVIEWR" && bzr clean-tree --force || exit 1
    sed --in-place "s/\/usr/$(echo "$HOME/opt/qpdfview-$QPDFVIEWV/usr"|sed -e 's/[]\/()$*.^|[]/\\&/g')/" qpdfview.pri
    qmake && make && make install || exit 1
    cd "$HOME/opt"
    ln -nsf qpdfview-$QPDFVIEWV qpdfview
    cd ../.bin
    ln -nsf ../opt/qpdfview-$QPDFVIEWV/usr/bin/qpdfview
    cd ..
fi

if ! [ -e "opt/mcabber-$MCABBERV" ]
then
    curl -L "http://mcabber.com/files/mcabber-${MCABBERV}.tar.bz2" | tar jxf -
    cd mcabber-$MCABBERV
    ./configure --prefix=$HOME/opt/mcabber-$MCABBERV && make && make install || exit 1
    cd ../opt
    ln -nsf mcabber-$MCABBERV mcabber
    cd ../.bin
    ln -nsf ../opt/mcabber/bin/mcabber
    cd ..
    rm -rf mcabber-$MCABBERV
fi

if ! [ -e "opt/rtorrent-$RTORRENTV" ]
then
    wget "http://libtorrent.rakshasa.no/downloads/libtorrent-${LIBTORRENTV}.tar.gz" -O - | tar zxf -
    wget "http://libtorrent.rakshasa.no/downloads/rtorrent-${RTORRENTV}.tar.gz" -O - | tar zxf -
    cd libtorrent-${LIBTORRENTV}
    ./configure --prefix=$HOME/opt/rtorrent-$RTORRENTV && make && make install || exit 1
    cd ../rtorrent-${RTORRENTV}
    PKG_CONFIG_PATH=$HOME/opt/rtorrent-$RTORRENTV/lib/pkgconfig ./configure --prefix=$HOME/opt/rtorrent-$RTORRENTV && make && make install
    cd ../opt
    ln -nsf rtorrent-$RTORRENTV rtorrent
    cd ..
    rm -rf rtorrent-${RTORRENTV} libtorrent-${LIBTORRENTV}
    cd .bin
    ln -nsf ../opt/rtorrent/bin/rtorrent
    cd ..
fi

if ! [ -e "opt/svg2pdf-$SVG2PDFV" ]
then
    git clone git://people.freedesktop.org/~cworth/svg2pdf || exit 1
    cd svg2pdf
    git co "$SVG2PDFV"
    make || exit 1
    mkdir "../opt/svg2pdf-$SVG2PDFV"
    cp svg2pdf "../opt/svg2pdf-$SVG2PDFV"
    cd ../opt
    ln -nsf "svg2pdf-$SVG2PDFV" svg2pdf
    cd ../.bin
    ln -nsf "../opt/svg2pdf-$SVG2PDFV/svg2pdf"
    cd ..
    rm -rf "svg2pdf"
fi

if ! [ -e ".bin/text2pdf" ]
then
    wget http://www.eprg.org/pdfcorner/text2pdf/text2pdf.c
    gcc -o .bin/text2pdf text2pdf.c
    rm text2pdf.c
fi

if ! [ -e ".bin/sfnt2woff" -a -e ".bin/woff2sfnt" ]
then
    mkdir sfnt2woff
    cd sfnt2woff
    wget http://people.mozilla.com/~jkew/woff/woff-code-latest.zip
    unzip woff-code-latest.zip
    make || exit 1
    cp woff2sfnt ../.bin
    cp sfnt2woff ../.bin
    cd ..
    rm -rf sfnt2woff
fi

if ! [ -e ".bin/mutt-ics" ]
then
    cd "$HOME/opt"
    git clone https://github.com/dmedvinsky/mutt-ics || exit 1
    cd mutt-ics
    pip install -r requirements.txt || exit 1
    chmod +x src/main.py
    cd ../../.bin
    ln -s ../opt/mutt-ics/src/main.py mutt-ics
    cd ..
fi

function mkinstance {
    mkdir -p ".varia/instances/$1"
    for TAG in 1M 2PT 3SPT 4KO 5KS 6H 7V 8NRMS 9V
    do
        ln -nsf "$(which "$1")" ".varia/instances/$1/$TAG"
    done
}

rm -rf ".varia/instances"
mkinstance qpdfview
mkinstance urxvt
