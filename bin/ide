#!/usr/bin/env bash

if [ -n "$1" ]
then
    SESSION_NAME="$1"
else
    SESSION_NAME="$(basename $(pwd) | tr '.' '-')-$(pwd | md5sum | cut -f 1 -d ' ')"
fi
if ! tty --silent
then
    urxvt -e bash -c "ide $SESSION_NAME"
    exit
fi

NEW_ARGS=""

SESSION_FILE="$(mktemp /tmp/tmp.XXXXX)"
echo "new-window -n e 'TMUX= settitle \$(basename \"\$(pwd)\");stty -ixon;settmuxtitle e;e;echo e;bash'" >> "$SESSION_FILE"
echo "new-window -n gitsh 'TMUX= settitle \$(basename \"\$(pwd)\");stty -ixon;settmuxtitle gitsh;gitsh;echo gitsh;bash'" >> "$SESSION_FILE"
echo "new-window -n tig 'TMUX= settitle \$(basename \"\$(pwd)\");stty -ixon;settmuxtitle tig;tig;echo tig;bash'" >> "$SESSION_FILE"
echo "last-window -t '$SESSION_NAME'" >> "$SESSION_FILE"
echo "select-pane -t 'gitsh'" >> "$SESSION_FILE"

DETACHED="$2"
if [ "$DETACHED" = "detached" ]
then
    NEW_ARGS=" -d"
fi

tmux attach-session -t "$SESSION_NAME" || tmux new-session${NEW_ARGS} -s "$SESSION_NAME" "tmux source-file "$SESSION_FILE""
rm "$SESSION_FILE"
