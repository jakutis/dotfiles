#!/usr/bin/env bash

CONNECTED_DISPLAYS="$(xrandr|grep -i ' connected '|sed 's/ .*//')"
NEXT_DISPLAY="$1"
CURRENT_DISPLAY="$(cat "$HOME/.varia/display")"
FOUND_CURRENT="false"

if [ -n "$NEXT_DISPLAY" -a -z "$(echo "$CONNECTED_DISPLAYS" | grep "^${NEXT_DISPLAY}$")" ]
then
    echo "Error: no such display "$NEXT_DISPLAY"." 2>&1
    exit 1
fi

if [ -z "$CURRENT_DISPLAY" ]
then
    CURRENT_DISPLAY="${CONNECTED_DISPLAYS%% *}"
fi

if [ -z "$NEXT_DISPLAY" ]
then
    FOUND_CURRENT="false"
    for D in $CONNECTED_DISPLAYS
    do
        if [ "$FOUND_CURRENT" = "true" ]
        then
            NEXT_DISPLAY="$D"
            break
        elif [ "$CURRENT_DISPLAY" = "$D" ]
        then
            FOUND_CURRENT="true"
        fi
    done
fi

if [ -z "$NEXT_DISPLAY" ]
then
    NEXT_DISPLAY="${CONNECTED_DISPLAYS%% *}"
fi

echo "Connected displays: $CONNECTED_DISPLAYS"
echo "Current display: $CURRENT_DISPLAY"
echo "Next display: $NEXT_DISPLAY"

if [ "$CURRENT_DISPLAY" = "$NEXT_DISPLAY" ]
then
    echo "No action needed"
else
    xrandr --output "$NEXT_DISPLAY" --auto --output "$CURRENT_DISPLAY" --off
    echo "$NEXT_DISPLAY" > "$HOME/.varia/display"
fi
