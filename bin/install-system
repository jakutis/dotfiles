#!/usr/bin/env bash

PHPV="5.4.10"
APCV="3.1.13"
CGITV="0.9.0.3"
NGINXV="1.2.6"
HAPROXYV="1.4.22"
HAPROXYURL="http://haproxy.1wt.eu/download/1.4/src/haproxy-1.4.22.tar.gz"

PACMAN="$(which pacman 2>/dev/null)"
APTGET="$(which apt-get 2>/dev/null)"

if [ -n "$PACMAN" ]
then
    "$PACMAN" -S --needed psmisc git vim kdebase-konqueror kdegraphics-okular awesome chromium rxvt-unicode mplayer-vaapi vlc ffmpeg openssh cups octave coreutils powertop libxslt wavpack lame flac bchunk mp3splt cuetools python2-eyed3 id3lib mp3info faac mac libmp4v2 samba ethtool mercurial texlive-most parted kdegraphics-ksnapshot smartmontools htop dstat dnsmasq protobuf zlib libutempter pkg-config openssl ncurses curl sqlite libxml2 stfl json-c gettext bzip2 markdown pcre libyaml elinks openvpn bridge-utils fetchmail postfix unzip gmp mesa freeglut hdparm parted qt libcups poppler-qt ebtables lsb-release alsa-utils mc smbclient autoconf libsigc++ yajl ntp pragha ethtool wol duplicity ntfs-3g ntfsprogs cmus gramps ejabberd mcabber irssi p7zip graphicsmagick zip sshfs perl-image-exiftool loudmouth librsvg lftp flex bison intltool

    if ! "$PACMAN" -Ql package-query 1>/dev/null 2>&1
    then
        DIR="$(mktemp -d)"
        cd "$DIR"
        wget https://aur.archlinux.org/packages/pa/package-query/PKGBUILD
        makepkg --asroot
        pacman -U *.pkg.tar.xz
        cd -
        rm -rf "$DIR"
    fi

    if ! "$PACMAN" -Ql yaourt 1>/dev/null 2>&1
    then
        DIR="$(mktemp -d)"
        cd "$DIR"
        wget https://aur.archlinux.org/packages/ya/yaourt/PKGBUILD
        makepkg --asroot
        pacman -U *.pkg.tar.xz
        cd -
        rm -rf "$DIR"
    fi

    for PKG in gmp4 thttpd git-annex-bin rar pan ttf-ms-fonts graphicsmagick-imagemagick-compat gdk-pixbuf-psd transmission-cli ttf2eot
    do
        if ! "$PACMAN" -Ql "$PKG" 1>/dev/null 2>&1
        then
            yaourt -S "$PKG"
        fi
    done
elif [ -n "$APTGET" ]
then
    wget -q http://download.virtualbox.org/virtualbox/debian/oracle_vbox.asc -O- | sudo apt-key add -
    "$APTGET" update
    "$APTGET" install psmisc git vim konqueror okular awesome chromium-browser rxvt-unicode mplayer vlc ffmpeg openssh-server openssh-client cups octave realpath powertop xsltproc wavpack ffmpeg flac bchunk mp3splt cuetools eyeD3 libid3-tools mp3info samba ethtool mercurial texlive-full parted ksnapshot smartmontools htop dstat dnsmasq libprotobuf-dev libprotobuf-c0-dev protobuf-c-compiler protobuf-compiler libz-dev libutempter-dev pkg-config libssl-dev libncurses-dev g++ curl libcurl4-openssl-dev libsqlite3-dev libxml2-dev libstfl-dev libjson0-dev gettext bzip2 thttpd markdown libpcre3-dev libyaml-dev elinks git-annex openvpn bridge-utils fetchmail postfix unzip libgmp3-dev libgl1-mesa-dev libglut3-dev hdparm parted qt4-qmake libcups2-dev libpoppler-qt4-dev rar ebtables lsb-release alsa-utils mc smbclient pan autoconf ttf-mscorefonts-installer libsigc++-2.0-dev ntpdate ethtool wakeonlan duplicity ntfs-3g ntfsprogs cmus gramps ejabberd mcabber irssi p7zip graphicsmagick graphicsmagick-imagemagick-compat zip sshfs libimage-exiftool-perl libloudmouth1-dev librsvg2-dev lftp transmission-cli flex bison intltool
    # TODO add these rygel dependencies also to pacman
    "$APTGET" libp11-dev libicu-dev libdbus-glib-1-dev libogg-dev libasound2-dev libvorbis-dev libtheora-dev libwavpack-dev libdv-dev libjpeg-dev libpulse-dev libshout-dev libavcodec-dev libbz2-dev libcdaudio-dev libcelt-dev libdirac-dev libdca-dev libfaad-dev flite-dev libgme-dev libopenjpeg-dev libkate-dev ladspa-sdk-dev libmms-dev libslv2-dev libmimic-dev libmodplug-dev libmpeg2-4-dev libmusicbrainz-dev libneon27-gnutls-dev libofa0-dev libopenal-dev libopus-dev librtmp-dev libschroedinger-dev libsoundtouch-dev libspandsp-dev timidity libvo-amrwbenc-dev libvo-aacenc-dev libvpx-dev libwildmidi-dev libxvidcore-dev libzbar-dev libmp3lame-dev libtwolame-dev liba52-dev libopencore-amrnb-dev libopencore-amrwb-dev libcdio-dev libdvdread-dev libmad0-dev libsidplay1-dev libsidplay2-dev libsidutils-dev libx264-dev
    # TODO add when these are in official repositories: pragha, gdk-pixbuf-psd
    ARCH="$(dpkg --print-architecture)"


    if ! dpkg-query --status libfaac-dev 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/f/faac/libfaac-dev_1.28-0.3_$ARCH.deb
        dpkg -i libfaac-dev_1.28-0.3_$ARCH.deb
        rm libfaac-dev_1.28-0.3_$ARCH.deb
    fi

    if ! dpkg-query --status libmp4v2-1 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/m/mp4v2/libmp4v2-1_1.9.1-0.1_$ARCH.deb
        dpkg -i libmp4v2-1_1.9.1-0.1_$ARCH.deb
        rm libmp4v2-1_1.9.1-0.1_$ARCH.deb
    fi

    if ! dpkg-query --status libfaac0 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/f/faac/libfaac0_1.28-0.3_$ARCH.deb
        dpkg -i libfaac0_1.28-0.3_$ARCH.deb
        rm libfaac0_1.28-0.3_$ARCH.deb
    fi

    if ! dpkg-query --status faac 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/f/faac/faac_1.28-0.3_$ARCH.deb
        dpkg -i faac_1.28-0.3_$ARCH.deb
        rm faac_1.28-0.3_$ARCH.deb
    fi

    if ! dpkg-query --status libmac2 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/m/monkeys-audio/libmac2_3.99-u4-b5-0.1_$ARCH.deb
        dpkg -i libmac2_3.99-u4-b5-0.1_$ARCH.deb
        rm libmac2_3.99-u4-b5-0.1_$ARCH.deb
    fi

    if ! dpkg-query --status monkeys-audio 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/m/monkeys-audio/monkeys-audio_3.99-u4-b5-0.1_$ARCH.deb
        dpkg -i monkeys-audio_3.99-u4-b5-0.1_$ARCH.deb
        rm monkeys-audio_3.99-u4-b5-0.1_$ARCH.deb
    fi

    if ! dpkg-query --status libmpeg4ip-0 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/m/mpeg4ip/libmpeg4ip-0_1.6-0.9_$ARCH.deb
        dpkg -i libmpeg4ip-0_1.6-0.9_$ARCH.deb
        rm libmpeg4ip-0_1.6-0.9_$ARCH.deb
    fi

    if ! dpkg-query --status libmp4v2-0 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/m/mpeg4ip/libmp4v2-0_1.6-0.9_$ARCH.deb
        dpkg -i libmp4v2-0_1.6-0.9_$ARCH.deb
        rm libmp4v2-0_1.6-0.9_$ARCH.deb
    fi

    if ! dpkg-query --status mpeg4ip-utils 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/m/mpeg4ip/mpeg4ip-utils_1.6-0.9_$ARCH.deb
        dpkg -i mpeg4ip-utils_1.6-0.9_$ARCH.deb
        rm mpeg4ip-utils_1.6-0.9_$ARCH.deb
    fi

    if ! dpkg-query --status lame 2>&1 1>/dev/null
    then
        wget http://deb-multimedia.org/pool/main/l/lame/lame_3.98.4-0.0_$ARCH.deb
        dpkg -i lame_3.98.4-0.0_$ARCH.deb
        rm lame_3.98.4-0.0_$ARCH.deb
    fi
else
    echo "Unknown package manager, only pacman and apt-get are supported"
    exit 1
fi

if ! [ -e "/opt/varia-nginx" ]
then
    mkdir -p /opt
    cd /opt
    wget http://nginx.org/download/nginx-$NGINXV.tar.gz
    tar xf nginx-$NGINXV.tar.gz
    cd nginx-$NGINXV
    ./configure --prefix=/opt/varia-nginx --with-ipv6 --with-http_ssl_module && make && make install
fi

if ! [ -e "/opt/varia-cgit" ]
then
    mkdir -p /opt
    cd /opt
    wget http://hjemli.net/git/cgit/snapshot/cgit-$CGITV.tar.gz
    tar xf cgit-$CGITV.tar.gz
    cd cgit-$CGITV
    make get-git && make prefix=/opt/varia-cgit CGIT_SCRIPT_PATH=/opt/varia-cgit/www CGIT_CONFIG=/home/tahu/Desktop/VARIA/server/cgitrc CACHE_ROOT=/tmp/cgit install
fi

if ! [ -e "/opt/varia-php" ]
then
    mkdir -p /opt
    cd /opt
    wget http://lt1.php.net/get/php-$PHPV.tar.bz2/from/this/mirror
    tar xf mirror
    rm mirror
    cd php-$PHPV
    wget http://pecl.php.net/get/APC-$APCV.tgz
    tar xf APC-$APCV.tgz
    rm APC-$APCV.tgz
    mv APC-$APCV ext/apc
    rm configure
    ./buildconf --force
    ./configure --prefix=/opt/varia-php --with-pdo-mysql --enable-apc --enable-fpm --with-fpm-user=www-data --with-fpm-group=www-data --with-mysql --enable-pcntl && make && make install
fi

if ! [ -e "/opt/varia-haproxy" ]
then
    mkdir -p /opt
    cd /opt
    wget "$HAPROXYURL"
    tar xf haproxy-$HAPROXYV.tar.gz
    cd haproxy-$HAPROXYV
    make PREFIX=/opt/varia-haproxy install
fi

