#!/usr/bin/env bash

MACHINE="$(cat "$XDG_CONFIG_HOME/dotfiles/machine")"
if [ -z "$MACHINE" ]
then
    echo "Please create a file "$XDG_CONFIG_HOME/dotfiles/machine" that contains the name of the current machine" 1>&2
    exit 1
fi

VARIA="$(cat "$XDG_CONFIG_HOME/dotfiles/varia")"
if [ -z "$VARIA" ]
then
    echo "Please create a file "$XDG_CONFIG_HOME/dotfiles/varia" that contains path to the varia directory" 1>&2
    exit 1
fi

set -o verbose
set -o xtrace

PACMAN="$(which pacman 2>/dev/null)"
APTGET="$(which apt-get 2>/dev/null)"
DNF="$(which dnf 2>/dev/null)"

if [ -n "$PACMAN" ]
then
    "$PACMAN" --sync --needed gnu-netcat socat psmisc git vim kdebase-konqueror kdegraphics-okular awesome mplayer vlc ffmpeg openssh cups octave coreutils powertop libxslt wavpack lame flac bchunk mp3splt cuetools python2-eyed3 id3lib mp3info faac mac libmp4v2 samba ethtool mercurial texlive-most parted kdegraphics-ksnapshot smartmontools htop dstat dnsmasq protobuf zlib libutempter pkg-config openssl ncurses curl sqlite libxml2 stfl json-c gettext bzip2 markdown pcre libyaml elinks openvpn bridge-utils fetchmail postfix unzip gmp mesa freeglut hdparm parted qt libcups poppler-qt ebtables lsb-release alsa-utils mc smbclient autoconf libsigc++ yajl ntp ethtool wol duplicity ntfs-3g ntfsprogs cmus gramps ejabberd mcabber irssi p7zip imagemagick zip sshfs perl-image-exiftool loudmouth librsvg lftp flex bison intltool python2-cheetah python2-pyopenssl par2cmdline rygel xorg-xdm yasm xorg-xclock xorg-xinput xdotool libspectre tidyhtml astyle ack wget vicious virtualbox virtualbox-guest-iso osmo mariadb gksu ebtables dhclient wpa_supplicant beep xbindkeys zenity wmname cmake bzr subversion wvdial sage-mathematics gimp libreoffice sane mirage leafpad skype-call-recorder ifuse python2-lxml wireless_tools patch pkgfile automake libtool dosfstools vpnc tmux pwgen gsasl dos2unix ghc gtkmm poppler-glib python2 tcpdump audacity recoll pstotext antiword catdoc unrtf mutagen python2-pychm aspell-en xchm xclip wireshark-gtk couchdb iw sysstat pinentry scons gstreamer0.10-ugly-plugins gstreamer0.10-good-plugins gstreamer0.10-base-plugins gstreamer0.10-bad-plugins dnsutils thttpd gnuplot libcue calibre libmpcdec gawk gdbm ctags cscope python-scipy python2-scipy gcc-multilib gcc-fortran xorg-xinit make pulseaudio pavucontrol clang iotop nload lame usbutils joystick dia inkscape xchm asciidoc docbook2x rtmpdump pv chromium cabextract lm_sensors roxterm tinyxml libid3tag ccd2iso kdebase-workspace rsync poppler-qt5 re2c skype mailman ocaml camlp4 zeromq multitail minidlna meld traceroute tree gdb libupnp graphviz apr apr-util serf libsasl xscreensaver unrar autocutsel jdk7-openjdk cppunit rtorrent qemu cpuburn xcompmgr libusb libnotify emacs || exit 1

    if ! "$PACMAN" --query --list package-query 1>/dev/null 2>&1
    then
        DIR="$( mktemp --directory )"
        cd "$DIR"
        wget https://aur.archlinux.org/packages/pa/package-query/PKGBUILD
        makepkg --asroot
        pacman --upgrade *.pkg.tar.xz
        cd -
        rm --recursive "$DIR"
    fi

    if ! "$PACMAN" -Ql yaourt 1>/dev/null 2>&1
    then
        DIR="$( mktemp --directory )"
        cd "$DIR"
        wget https://aur.archlinux.org/packages/ya/yaourt/PKGBUILD
        makepkg --asroot
        pacman --upgrade *.pkg.tar.xz
        cd -
        rm --recursive "$DIR"
    fi

    for PKG in rar ttf-ms-fonts transmission-cli ttf2eot python2-yenc pdfgrep v4l2loopback-dkms-git python-autopep8 ideviceinstaller-git ocrodjvu pdftk teamviewer virtualbox-ext-oracle jbig2enc-git proftpd haproxy darcs jmtpfs
    do
        if ! "$PACMAN" --query --list "$PKG" 1>/dev/null 2>&1
        then
            su -s /bin/bash -c "yaourt --sync --noconfirm $PKG" nobody || exit 1
        fi
    done
elif [ -n "$APTGET" ]
then
    "$APTGET" install wget && wget --quiet https://www.virtualbox.org/download/oracle_vbox.asc --output-document=- | apt-key add - || exit 1
    "$APTGET" update || exit 1
    # add when these are in official repositories: gdk-pixbuf-psd autopep8 vicious sage-mathematics skype skype-call-recorder teamviewer virtualbox-ext-oracle jbig2enc thttpd libpoppler-glib4
    "$APTGET" install apt-file netcat-traditional socat psmisc git vim mp4v2-utils konqueror okular awesome chromium mplayer vlc libav-tools openssh-server openssh-client cups octave realpath powertop xsltproc wavpack v4l2loopback-utils flac bchunk mp3splt cuetools rar eyeD3 libid3-tools mp3info samba ethtool mercurial texlive-full parted ksnapshot smartmontools htop dstat dnsmasq libprotobuf-dev libprotobuf-c0-dev protobuf-c-compiler protobuf-compiler libz-dev libutempter-dev pkg-config libssl-dev libncurses-dev g++ curl libsqlite3-dev libxml2-dev libstfl-dev libjson0-dev gettext bzip2 markdown libpcre3-dev libyaml-dev elinks openvpn bridge-utils fetchmail postfix unzip libgmp3-dev libgl1-mesa-dev hdparm parted qt4-qmake libcups2-dev libpoppler-qt4-dev ebtables lsb-release alsa-utils mc smbclient autoconf libsigc++-2.0-dev ntpdate ethtool wakeonlan duplicity ntfs-3g cmus gramps ejabberd mcabber irssi p7zip imagemagick zip sshfs libimage-exiftool-perl libloudmouth1-dev librsvg2-dev lftp transmission-cli flex bison intltool python-cheetah python-yenc par2 p7zip-full xdm yasm x11-apps xinput xdotool libspectre-dev pdfgrep libcups2-dev tidy astyle gfortran libreadline-dev wget virtualbox-5.0 osmo mysql-server gksu ebtables isc-dhcp-client wpasupplicant beep xbindkeys zenity wmname cmake bzr subversion wvdial python-lxml gimp sane mirage leafpad ocrodjvu pdftk ifrename patch dosfstools tmux pwgen libgsasl7-dev dos2unix ghc libgtkmm-2.4 tcpdump audacity recoll xpdf pstotext antiword catdoc unrtf untex python-mutagen python-chm aspell-en xclip wireshark iw sysstat pinentry-curses scons proftpd gstreamer0.10-plugins-ugly gstreamer0.10-plugins-good gstreamer0.10-plugins-base gstreamer0.10-plugins-bad dnsutils gnuplot libcue-dev libroar-dev calibre libmpcdec-dev gawk libgdbm-dev ctags cscope python-scipy gcc xinit make pulseaudio pavucontrol vainfo libffi-dev sqlite3 libelf-dev libacl1-dev libattr1-dev libgpm-dev libxpm-dev okular-extra-backends systemsettings libflac-dev libmagic-dev libgs-dev libmupdf-dev libgif-dev clang iotop nload lame libbtparse-dev usbutils joystick dia inkscape xchm libmcrypt-dev asciidoc docbook2x rtmpdump pv cabextract libp11-dev libicu-dev libdbus-glib-1-dev libogg-dev libasound2-dev libvorbis-dev libtheora-dev libwavpack-dev libdv-dev libjpeg-dev libpulse-dev libshout-dev libavcodec-dev libbz2-dev libcdaudio-dev libdirac-dev libdca-dev libfaad-dev flite-dev libgme-dev libopenjpeg-dev libkate-dev ladspa-sdk-dev libmms-dev libslv2-dev libmimic-dev libmodplug-dev libmpeg2-4-dev libneon27-gnutls-dev libofa0-dev libopenal-dev libopus-dev librtmp-dev libschroedinger-dev libsoundtouch-dev libspandsp-dev timidity libvo-amrwbenc-dev libvo-aacenc-dev libvpx-dev libwildmidi-dev libxvidcore-dev libzbar-dev libmp3lame-dev libtwolame-dev liba52-dev libopencore-amrnb-dev libopencore-amrwb-dev libcdio-dev libdvdread-dev libmad0-dev libsidplay1-dev libsidplay2-dev libsidutils-dev libx264-dev libxv-dev libxvmc-dev libzzip-dev libjpeg-dev libfreetype6-dev lm-sensors bibutils libfuse-dev libudev-dev libzip-dev roxterm libtinyxml-dev libid3tag0-dev ccd2iso bsdtar rsync re2c libtidy-dev libreoffice ideviceinstaller python-openssl freeglut3-dev p7zip-rar ttf-mscorefonts-installer mailman haproxy ocaml camlp4-extra libzmq-dev multitail minidlna meld traceroute tree gdb libupnp-dev graphviz libapr1-dev libaprutil1-dev libserf-dev libsasl2-dev xscreensaver darcs unrar autocutsel openjdk-7-jdk libcppunit-dev rtorrent libc6-dev-i386 qemu-kvm cpuburn xcompmgr libusb-1.0-0-dev libnotify-bin jmtpfs kde-workspace-bin libusb-1.0-0-dev emacs libtool-bin || exit 1
else
    echo "Unknown package manager, only pacman and apt-get are supported"
    exit 1
elif [ -n "$DNF" ]
then
    systemctl disable gdm
    dnf update
    dnf install roxterm awesome automake osmo leafpad texinfo gcc gcc-c++ okular python konqueror libreoffice claws-mail gstreamer-plugins-bad-free-extras gstreamer-plugins-good-extras kmplayer gstreamer1-vaapi xcompmgr reinstall llvm tmux libtool-ltdl-devel mercurial pavucontrol libyaml-devel readline-devel zlib-devel libffi-devel openssl-devel libtool bison sqlite-devel subversion gcc-gfortran bzr sshfs flac-devel pulseaudio-libs-devel xbindkeys parcellite cmake mc libxml2-devel ack mirage meld ocaml dstat gmp-devel redhat-rpm-config ocaml-ocamldoc ocaml-camlp4 ocaml-camlp4-devel ocaml-cryptokit fuse-devel libXaw-devel giflib-devel protobuf-devel intltool libuv-devel libzip-devel || exit 1
    dnf build-dep R || exit 1
fi

if [ "$MACHINE" = "server" ]
then
    ln -nsf "$VARIA/server/aliases" "/etc/aliases" || exit 1
    ln -nsf "$VARIA/server/apcupsd.conf" "/etc/apcupsd/apcupsd.conf" || exit 1
    ln -nsf "$VARIA/server/haproxy.cfg" "/etc/haproxy/haproxy.cfg" || exit 1
    ln -nsf "$VARIA/server/main.cf" "/etc/postfix/main.cf" || exit 1
    ln -nsf "$VARIA/server/transport" "/etc/postfix/transport" || exit 1
    ln -nsf "$VARIA/server/procmailrc" "/etc/procmailrc" || exit 1
    ln -nsf "$VARIA/server/rc.local" "/etc/rc.local" || exit 1
    ln -nsf "$VARIA/scrub-md" "/etc/cron.monthly/scrub-md" || exit 1
fi
