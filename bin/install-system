#!/usr/bin/env bash

if [ "$(id -u)" != "0" ]
then
    echo cannot continue as a non-root user
    exit 1
fi

set -o verbose
set -o xtrace

if [ -z "$1" ]
then
  echo "Please provide main username as the first argument"
  exit 1
fi
MAIN_USER="$1"
MAIN_HOME="$(eval echo ~$MAIN_USER)"
XDG_CONFIG_HOME="$MAIN_HOME/.config"

PACMAN="$(which pacman 2>/dev/null)"
APTGET="$(which apt-get 2>/dev/null)"
DNF="$(which dnf 2>/dev/null)"

if [ -n "$PACMAN" ]
then
    "$PACMAN" --sync --needed gnu-netcat socat psmisc git vim kdebase-konqueror kdegraphics-okular mplayer vlc ffmpeg openssh cups octave coreutils powertop libxslt wavpack lame flac bchunk mp3splt cuetools python2-eyed3 id3lib mp3info faac mac libmp4v2 samba ethtool mercurial texlive-most parted kdegraphics-ksnapshot smartmontools htop dstat dnsmasq protobuf zlib libutempter pkg-config openssl ncurses curl sqlite libxml2 stfl json-c gettext bzip2 markdown pcre libyaml elinks openvpn bridge-utils fetchmail postfix unzip gmp mesa freeglut hdparm parted qt libcups poppler-qt ebtables lsb-release alsa-utils mc smbclient autoconf libsigc++ yajl ntp ethtool wol duplicity ntfs-3g ntfsprogs cmus gramps ejabberd mcabber irssi p7zip imagemagick zip sshfs perl-image-exiftool loudmouth librsvg lftp flex bison intltool python2-cheetah python2-pyopenssl par2cmdline rygel yasm xorg-xclock xorg-xinput xdotool libspectre tidyhtml astyle ack wget vicious virtualbox virtualbox-guest-iso osmo mariadb gksu ebtables dhclient wpa_supplicant beep xbindkeys zenity wmname cmake bzr subversion wvdial sage-mathematics gimp libreoffice sane skype-call-recorder ifuse python2-lxml wireless_tools patch pkgfile automake libtool dosfstools vpnc tmux pwgen gsasl dos2unix ghc gtkmm poppler-glib python2 tcpdump audacity recoll pstotext antiword catdoc unrtf mutagen python2-pychm aspell-en xchm xclip wireshark-gtk couchdb iw sysstat pinentry scons gstreamer0.10-ugly-plugins gstreamer0.10-good-plugins gstreamer0.10-base-plugins gstreamer0.10-bad-plugins dnsutils thttpd gnuplot libcue calibre libmpcdec gawk gdbm ctags cscope python-scipy python2-scipy gcc-multilib gcc-fortran xorg-xinit make pulseaudio pavucontrol clang iotop nload lame usbutils joystick dia inkscape xchm asciidoc docbook2x rtmpdump pv cabextract lm_sensors tinyxml libid3tag ccd2iso kdebase-workspace rsync poppler-qt5 re2c skype mailman ocaml camlp4 zeromq multitail minidlna meld traceroute tree gdb libupnp graphviz apr apr-util serf libsasl xscreensaver unrar autocutsel jdk7-openjdk cppunit rtorrent qemu cpuburn xcompmgr libusb libnotify emacs || exit 1

    if ! "$PACMAN" --query --list package-query 1>/dev/null 2>&1
    then
        DIR="$( mktemp --directory )"
        cd "$DIR"
        wget https://aur.archlinux.org/packages/pa/package-query/PKGBUILD
        makepkg --asroot
        pacman --upgrade *.pkg.tar.xz
        cd -
        rm --recursive "$DIR"
    fi

    if ! "$PACMAN" -Ql yaourt 1>/dev/null 2>&1
    then
        DIR="$( mktemp --directory )"
        cd "$DIR"
        wget https://aur.archlinux.org/packages/ya/yaourt/PKGBUILD
        makepkg --asroot
        pacman --upgrade *.pkg.tar.xz
        cd -
        rm --recursive "$DIR"
    fi

    for PKG in rar ttf-ms-fonts transmission-cli ttf2eot python2-yenc pdfgrep v4l2loopback-dkms-git python-autopep8 ideviceinstaller-git ocrodjvu pdftk teamviewer virtualbox-ext-oracle jbig2enc-git proftpd haproxy darcs jmtpfs
    do
        if ! "$PACMAN" --query --list "$PKG" 1>/dev/null 2>&1
        then
            su -s /bin/bash -c "yaourt --sync --noconfirm $PKG" nobody || exit 1
        fi
    done
elif [ -n "$APTGET" ]
then
    dpkg --add-architecture i386 || exit 1
    "$APTGET" install lsb-release apt-transport-https wget gnupg || exit 1

    if [ -z "$(grep virtualbox /etc/apt/sources.list)" ]
    then
        wget --quiet --output-document=- https://www.virtualbox.org/download/oracle_vbox.asc | apt-key add - || exit 1
        wget --quiet --output-document=- https://www.virtualbox.org/download/oracle_vbox_2016.asc | apt-key add - || exit 1
        echo "deb http://download.virtualbox.org/virtualbox/debian $(lsb_release -cs) contrib" >> /etc/apt/sources.list
    fi
    if [ -z "$(grep docker /etc/apt/sources.list)" ]
    then
        wget --quiet --output-document=- https://download.docker.com/linux/debian/gpg | apt-key add - || exit 1
        echo "deb [arch=$(dpkg --print-architecture)] https://download.docker.com/linux/debian $(lsb_release -cs) stable" >> /etc/apt/sources.list
    fi

    "$APTGET" update && "$APTGET" upgrade -y || exit 1
    # add when these are in official repositories: gdk-pixbuf-psd autopep8 vicious sage-mathematics skype skype-call-recorder teamviewer virtualbox-ext-oracle jbig2enc thttpd libpoppler-glib4
    # add if available virtualbox-6.0 ripgrep mbpfan libc6-dev-i386 festvox-us-slt-hts wine64 rar p7zip-rar unrar qemu-kvm
    "$APTGET" install -y urlview tcl-dev tk-dev libpcre2-dev fzf cgroup-tools gnome-clocks mediainfo nautilus devhelp cppreference-doc-en-html libmpc-dev libmpfr-dev detox libjson-c-dev festival moreutils eject dbus-x11 linux-perf libtinfo5 efivar python-dev python3-dev python3-gpg wine32 stress gobject-introspection libpcap-dev libcap-dev libarchive-dev libgpgme-dev libpolkit-agent-1-dev libostree-dev libjson-glib-dev libappstream-glib-dev libseccomp-dev libsoup2.4-dev libconfuse-dev libyajl-dev libiw-dev libnl-genl-3-dev xsel polkit-kde-agent-1 libimobiledevice-dev libusb-dev libevent-dev libcurl4-openssl-dev inotify-tools gnupg2 konsole libproxy-dev vpnc-scripts whois flatpak geary geany aptitude firefox-esr apt-file netcat-traditional socat psmisc git vim konqueror okular mplayer vlc openssh-server openssh-client cups octave powertop xsltproc wavpack flac bchunk cuetools libid3-tools mp3info samba ethtool mercurial texlive-full parted ksnapshot smartmontools htop dstat dnsmasq libprotobuf-dev libprotobuf-c-dev protobuf-c-compiler protobuf-compiler zlib1g-dev libutempter-dev pkg-config libssl-dev libncurses5-dev g++ curl libsqlite3-dev libxml2-dev libstfl-dev gettext bzip2 markdown libpcre3-dev libyaml-dev elinks openvpn bridge-utils fetchmail postfix unzip libgmp3-dev libgl1-mesa-dev hdparm parted qt4-qmake libcups2-dev ebtables lsb-release alsa-utils mc smbclient autoconf libsigc++-2.0-dev ntpdate ethtool wakeonlan duplicity ntfs-3g cmus gramps ejabberd mcabber irssi p7zip imagemagick zip sshfs libimage-exiftool-perl libloudmouth1-dev librsvg2-dev lftp transmission-cli flex bison intltool python-cheetah python-yenc par2 p7zip-full yasm x11-apps xinput xdotool libspectre-dev pdfgrep libcups2-dev tidy astyle gfortran libreadline-dev osmo ebtables isc-dhcp-client wpasupplicant beep xbindkeys zenity suckless-tools cmake bzr subversion wvdial python-lxml gimp sane viewnior ocrodjvu pdftk ifrename patch dosfstools tmux pwgen libgsasl7-dev dos2unix ghc tcpdump audacity recoll xpdf antiword catdoc unrtf untex python-mutagen python-chm aspell-en xclip wireshark iw sysstat pinentry-curses scons dnsutils gnuplot libcue-dev libroar-dev calibre libmpcdec-dev gawk libgdbm-dev exuberant-ctags cscope python-scipy gcc xinit make pulseaudio pavucontrol vainfo libffi-dev sqlite3 libelf-dev libacl1-dev libattr1-dev libgpm-dev libxpm-dev okular-extra-backends systemsettings libflac-dev libmagic-dev libgs-dev libmupdf-dev libgif-dev clang iotop nload lame libbtparse-dev usbutils joystick dia inkscape xchm libmcrypt-dev asciidoc docbook2x rtmpdump pv cabextract libicu-dev libdbus-glib-1-dev libogg-dev libasound2-dev libvorbis-dev libtheora-dev libwavpack-dev libdv4-dev libjpeg-dev libpulse-dev libshout3-dev libavcodec-dev libbz2-dev libcdaudio-dev libdca-dev libfaad-dev flite1-dev libgme-dev libkate-dev ladspa-sdk libmms-dev libmimic-dev libmodplug-dev libmpeg2-4-dev libneon27-gnutls-dev libofa0-dev libopenal-dev libopus-dev librtmp-dev libsoundtouch-dev libspandsp-dev timidity libvo-amrwbenc-dev libvo-aacenc-dev libvpx-dev libwildmidi-dev libxvidcore-dev libzbar-dev libmp3lame-dev libtwolame-dev liba52-0.7.4-dev libopencore-amrnb-dev libopencore-amrwb-dev libcdio-dev libdvdread-dev libmad0-dev libsidplay1-dev libsidplay2-dev libsidutils-dev libx264-dev libxv-dev libxvmc-dev libzzip-dev libjpeg-dev libfreetype6-dev lm-sensors bibutils libfuse-dev libudev-dev libzip-dev libtinyxml-dev libid3tag0-dev ccd2iso bsdtar rsync re2c libtidy-dev libreoffice ideviceinstaller python-openssl freeglut3-dev ttf-mscorefonts-installer haproxy ocaml camlp4 multitail minidlna meld traceroute tree gdb libupnp-dev graphviz libapr1-dev libaprutil1-dev libserf-dev libsasl2-dev xscreensaver darcs autocutsel libcppunit-dev rtorrent xcompmgr libusb-1.0-0-dev libnotify-bin jmtpfs libusb-1.0-0-dev emacs libtool-bin oathtool docker davfs2 ack-grep vifm software-properties-common docker-ce libplist-dev libusbmuxd-dev libplist++-dev parcellite net-tools dhex libva-dev vokoscreen bpm-tools nmap vpnc-scripts libproxy-dev liblz4-dev libyubikey-dev libglobus-gssapi-error-dev libglobus-gssapi-gsi-dev redshift jq mtools i3 blueman hplip-gui qpdf mousepad libonig-dev libmikmod-dev libcddb-dev libvorbisidec-dev libopusfile-dev libjack-dev libsamplerate-dev libsndio-dev libdiscid-dev libcdio-paranoia-dev libao-dev || exit 1
    "$APTGET" build-dep --assume-yes libopenconnect-dev || exit 1
    BATV="$(curl https://api.github.com/repos/sharkdp/bat/releases/latest|jq --raw-output .name|cut -b 2-)"
    DEVDOCSV="$(curl https://api.github.com/repos/egoist/devdocs-desktop/releases/latest|jq --raw-output .name|cut -b 2-)"
    if [ "$(bat --version)" != "bat $BATV" ]
    then
        wget https://github.com/sharkdp/bat/releases/download/v${BATV}/bat_${BATV}_$(dpkg --print-architecture).deb && dpkg -i bat_${BATV}_$(dpkg --print-architecture).deb && rm bat_${BATV}_$(dpkg --print-architecture).deb || exit 1
    fi

    if dpkg -l devdocs 1>/dev/null 2>&1
    then
      wget "https://github.com/egoist/devdocs-app/releases/download/v${DEVDOCSV}/DevDocs_${DEVDOCSV}_$(dpkg --print-architecture).deb" && dpkg -i "DevDocs_${DEVDOCSV}_$(dpkg --print-architecture).deb" && rm "DevDocs_${DEVDOCSV}_$(dpkg --print-architecture).deb" || exit 1
    fi
elif [ -n "$DNF" ]
then
    systemctl disable gdm
    dnf install https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm
    dnf update
    dnf install ruby hostapd macchanger iw ripgrep tidy libproxy-devel vpnc-script flatpak flatpak-builder make ostree uuid vlc libva-intel-driver unar xscreensaver ifuse rsync libimobiledevice-utils tree dolphin davfs2 wpa_supplicant pciutils net-tools dhcp-client bless geany mplayer oathtool tig calibre jq git xorg-x11-server-Xorg firefox automake osmo texinfo gcc gcc-c++ okular python konqueror libreoffice claws-mail gstreamer-plugins-bad-free-extras gstreamer-plugins-good-extras kmplayer gstreamer1-vaapi xcompmgr llvm tmux libtool-ltdl-devel mercurial pavucontrol libyaml-devel readline-devel zlib-devel libffi-devel openssl-devel libtool bison sqlite-devel subversion gcc-gfortran bzr sshfs flac-devel pulseaudio-libs-devel xbindkeys parcellite cmake mc libxml2-devel ack meld ocaml dstat gmp-devel redhat-rpm-config ocaml-ocamldoc ocaml-camlp4 ocaml-camlp4-devel ocaml-cryptokit fuse-devel libXaw-devel giflib-devel protobuf-devel intltool libuv-devel libzip-devel systemd-devel stfl-devel loudmouth-devel librsvg2-devel bsdtar libusb-devel docker apr-devel apr-util-devel libserf-devel nasm libvorbis-devel kernel-devel tinyxml-devel libupnp-devel qt-devel qtwebkit-devel libmcrypt-devel libtidy-devel libxslt-devel re2c xsel mongodb gimp p7zip htop octave ntpdate pv transmission-cli libnatpmp scons SDL-devel openal-soft-devel wine powertop inkscape-view kdesu pwgen texlive-pdfcrop-bin djvulibre ImageMagick-devel audacity asciidoc texlive-pdfjam bchunk libmpg123-devel wavpack-devel neon-devel libcue-devel libsndfile-devel fluidsynth-devel libmodplug-devel libsidplayfp-devel libcdio-paranoia-devel iotop libusbmuxd-devel libplist-devel xchm wget system-switch-displaymanager pulseaudio pulseaudio-utils pulseaudio-module-x11 konsole vokoscreen libcgroup-tools dos2unix dwdiff nmap byacc lsof || exit 1
    dnf build-dep R || exit 1
else
    echo "Unknown package manager, only pacman and apt-get are supported"
    exit 1
fi

gpasswd -a "$MAIN_USER" sudo

echo "setting up configs"

MACHINE="$(cat "$XDG_CONFIG_HOME/dotfiles/machine")"
if [ -z "$MACHINE" ]
then
    echo "Please create a file "$XDG_CONFIG_HOME/dotfiles/machine" that contains the name of the current machine" 1>&2
    exit 1
fi

echo "MACHINE=$MACHINE"

DOTFILES="$(cat "$XDG_CONFIG_HOME/dotfiles/dotfiles")"
if [ -z "$DOTFILES" ]
then
    echo "Please create a file "$XDG_CONFIG_HOME/dotfiles/dotfiles" that contains path to the dotfiles directory" 1>&2
    exit 1
fi

ln -nsf "$DOTFILES/modprobe.conf" "/etc/modprobe.d/jakutis.conf" || exit 1
ln -nsf "$DOTFILES/rc.local" "/etc/rc.local" || exit 1
echo 'ACTION=="add", SUBSYSTEM=="block", RUN+="'$MAIN_HOME'/bin/udevmount"' > "/etc/udev/rules.d/10-jakutis.rules" || exit 1
ln -nsf "$DOTFILES/sysctl.conf" "/etc/sysctl.d/99-jakutis.conf" || exit 1
"$DOTFILES/bin/disable-services" || exit 1

VARIA="$(cat "$XDG_CONFIG_HOME/dotfiles/varia")"
if [ -z "$VARIA" ]
then
    echo "Please create a file "$XDG_CONFIG_HOME/dotfiles/varia" that contains path to the varia directory" 1>&2
    exit 1
fi

if [ "$MACHINE" = "server" ]
then
    ln -nsf "$VARIA/server/aliases" "/etc/aliases" || exit 1
    ln -nsf "$VARIA/server/apcupsd.conf" "/etc/apcupsd/apcupsd.conf" || exit 1
    ln -nsf "$VARIA/server/haproxy.cfg" "/etc/haproxy/haproxy.cfg" || exit 1
    ln -nsf "$VARIA/server/main.cf" "/etc/postfix/main.cf" || exit 1
    ln -nsf "$VARIA/server/transport" "/etc/postfix/transport" || exit 1
    ln -nsf "$VARIA/server/procmailrc" "/etc/procmailrc" || exit 1
    ln -nsf "$VARIA/server/rc.local" "/etc/rc.local" || exit 1
    ln -nsf "$VARIA/scrub-md" "/etc/cron.monthly/scrub-md" || exit 1
else
    ln -nsf "$VARIA/wpa_supplicant.conf" "/etc/wpa_supplicant.conf" || exit 1
fi
