#!/usr/bin/env bash

set -o verbose
set -o xtrace

PACMAN="$(which pacman 2>/dev/null)"
APTGET="$(which apt-get 2>/dev/null)"

if [ -n "$PACMAN" ]
then
    "$PACMAN" --sync --needed gnu-netcat socat psmisc git vim kdebase-konqueror kdegraphics-okular awesome mplayer-vaapi vlc ffmpeg openssh cups octave coreutils powertop libxslt wavpack lame flac bchunk mp3splt cuetools python2-eyed3 id3lib mp3info faac mac libmp4v2 samba ethtool mercurial texlive-most parted kdegraphics-ksnapshot smartmontools htop dstat dnsmasq protobuf zlib libutempter pkg-config openssl ncurses curl sqlite libxml2 stfl json-c gettext bzip2 markdown pcre libyaml elinks openvpn bridge-utils fetchmail postfix unzip gmp mesa freeglut hdparm parted qt libcups poppler-qt ebtables lsb-release alsa-utils mc smbclient autoconf libsigc++ yajl ntp ethtool wol duplicity ntfs-3g ntfsprogs cmus gramps ejabberd mcabber irssi p7zip imagemagick zip sshfs perl-image-exiftool loudmouth librsvg lftp flex bison intltool python2-cheetah python2-pyopenssl par2cmdline rygel xorg-xdm yasm xorg-xclock xorg-xinput xdotool libpar2 libspectre tidyhtml astyle ack wget vicious virtualbox virtualbox-guest-iso osmo mariadb gksu ebtables dhclient wpa_supplicant beep xbindkeys zenity wmname cmake bzr subversion wvdial sage-mathematics gimp libreoffice sane mirage leafpad gnome-alsamixer skype-call-recorder ifuse python2-lxml wireless_tools patch pkgfile automake libtool dosfstools vpnc tmux pwgen gsasl dos2unix ghc gtkmm poppler-glib python2 tcpdump audacity recoll pstotext antiword catdoc unrtf mutagen python2-pychm aspell-en xchm xclip wireshark-gtk couchdb iw sysstat pinentry scons gstreamer0.10-ugly-plugins gstreamer0.10-good-plugins gstreamer0.10-base-plugins gstreamer0.10-bad-plugins dnsutils thttpd gnuplot libcue calibre libmpcdec gawk gdbm ctags cscope python-scipy python2-scipy gcc-multilib gcc-fortran xorg-xinit make pulseaudio pavucontrol clang iotop nload lame usbutils joystick dia inkscape xchm asciidoc docbook2x rtmpdump pv chromium cabextract lm_sensors rxvt-unicode tinyxml libid3tag ccd2iso kdebase-workspace rsync poppler-qt5 re2c skype mailman ocaml camlp4 zeromq multitail minidlna meld traceroute tree gdb libupnp graphviz apr apr-util serf || exit 1

    if ! "$PACMAN" --query --list package-query 1>/dev/null 2>&1
    then
        DIR="$( mktemp --directory )"
        cd "$DIR"
        wget https://aur.archlinux.org/packages/pa/package-query/PKGBUILD
        makepkg --asroot
        pacman --upgrade *.pkg.tar.xz
        cd -
        rm --recursive "$DIR"
    fi

    if ! "$PACMAN" -Ql yaourt 1>/dev/null 2>&1
    then
        DIR="$( mktemp --directory )"
        cd "$DIR"
        wget https://aur.archlinux.org/packages/ya/yaourt/PKGBUILD
        makepkg --asroot
        pacman --upgrade *.pkg.tar.xz
        cd -
        rm --recursive "$DIR"
    fi

    for PKG in rar ttf-ms-fonts gdk-pixbuf-psd transmission-cli ttf2eot python2-yenc pdfgrep v4l2loopback-git python-autopep8 ideviceinstaller-git ocrodjvu pdftk teamviewer virtualbox-ext-oracle jbig2enc-git proftpd haproxy
    do
        if ! "$PACMAN" --query --list "$PKG" 1>/dev/null 2>&1
        then
            yaourt --sync --noconfirm "$PKG"
        fi
    done
elif [ -n "$APTGET" ]
then
    "$APTGET" install wget && wget --quiet https://www.virtualbox.org/download/oracle_vbox.asc --output-document=- | apt-key add - || exit 1
    "$APTGET" update || exit 1
    # add when these are in official repositories: gdk-pixbuf-psd autopep8 vicious sage-mathematics skype skype-call-recorder teamviewer virtualbox-ext-oracle jbig2enc thttpd libpoppler-glib4
    "$APTGET" install apt-file netcat-traditional socat psmisc git vim mp4v2-utils konqueror okular awesome chromium-browser mplayer vlc ffmpeg openssh-server openssh-client cups octave realpath powertop xsltproc wavpack ffmpeg v4l2loopback-utils flac bchunk mp3splt cuetools rar eyeD3 libid3-tools mp3info samba ethtool mercurial texlive-full parted ksnapshot smartmontools htop dstat dnsmasq libprotobuf-dev libprotobuf-c0-dev protobuf-c-compiler protobuf-compiler libz-dev libutempter-dev pkg-config libssl-dev libncurses-dev g++ curl libsqlite3-dev libxml2-dev libstfl-dev libjson0-dev gettext bzip2 markdown libpcre3-dev libyaml-dev elinks openvpn bridge-utils fetchmail postfix unzip libgmp3-dev libgl1-mesa-dev hdparm parted qt4-qmake libcups2-dev libpoppler-qt4-dev ebtables lsb-release alsa-utils mc smbclient autoconf libsigc++-2.0-dev ntpdate ethtool wakeonlan duplicity ntfs-3g ntfsprogs cmus gramps ejabberd mcabber irssi p7zip imagemagick zip sshfs libimage-exiftool-perl libloudmouth1-dev librsvg2-dev lftp transmission-cli flex bison intltool python-cheetah python-yenc par2 p7zip-full xdm yasm x11-apps xinput xdotool libpar2-0-dev libspectre-dev pdfgrep libcups2-dev tidy astyle gfortran libreadline-dev ack wget virtualbox-4.3 osmo mysql-server gksu ebtables isc-dhcp-client wpasupplicant beep xbindkeys zenity wmname cmake bzr subversion wvdial python-lxml gimp sane mirage leafpad gnome-alsamixer ifuse ocrodjvu pdftk ifrename patch dosfstools tmux pwgen libgsasl7-dev dos2unix ghc libgtkmm-2.4 tcpdump audacity recoll xpdf pstotext antiword catdoc unrtf untex python-mutagen python-chm aspell-en xclip wireshark couchdb iw sysstat pinentry-curses scons proftpd gstreamer0.10-plugins-ugly gstreamer0.10-plugins-good gstreamer0.10-plugins-base gstreamer0.10-plugins-bad dnsutils gnuplot libcue-dev libroar-dev calibre libmpcdec-dev gawk libgdbm-dev ctags cscope python-scipy gcc xinit make pulseaudio pavucontrol vainfo libffi-dev sqlite3 libelf-dev libacl1-dev libattr1-dev libgpm-dev libxpm-dev okular-extra-backends systemsettings libflac-dev libmagic-dev libautotrace-dev libgs-dev libmupdf-dev libgif-dev clang iotop nload lame libbtparse-dev usbutils joystick dia inkscape xchm libmcrypt-dev asciidoc docbook2x rtmpdump pv cabextract libp11-dev libicu-dev libdbus-glib-1-dev libogg-dev libasound2-dev libvorbis-dev libtheora-dev libwavpack-dev libdv-dev libjpeg-dev libpulse-dev libshout-dev libavcodec-dev libbz2-dev libcdaudio-dev libdirac-dev libdca-dev libfaad-dev flite-dev libgme-dev libopenjpeg-dev libkate-dev ladspa-sdk-dev libmms-dev libslv2-dev libmimic-dev libmodplug-dev libmpeg2-4-dev libneon27-gnutls-dev libofa0-dev libopenal-dev libopus-dev librtmp-dev libschroedinger-dev libsoundtouch-dev libspandsp-dev timidity libvo-amrwbenc-dev libvo-aacenc-dev libvpx-dev libwildmidi-dev libxvidcore-dev libzbar-dev libmp3lame-dev libtwolame-dev liba52-dev libopencore-amrnb-dev libopencore-amrwb-dev libcdio-dev libdvdread-dev libmad0-dev libsidplay1-dev libsidplay2-dev libsidutils-dev libx264-dev libxv-dev libxvmc-dev libzzip-dev libjpeg-dev libfreetype6-dev lm-sensors bibutils libfuse-dev libudev-dev libzip-dev rxvt-unicode libtinyxml-dev libid3tag0-dev ccd2iso bsdtar rsync re2c libtidy-dev libreoffice ideviceinstaller python-openssl freeglut3-dev p7zip-rar ttf-mscorefonts-installer mailman haproxy ocaml camlp4-extra libzmq-dev multitail minidlna meld traceroute tree gdb libupnp-dev graphviz libapr1-dev libaprutil1-dev libserf-dev || exit 1
else
    echo "Unknown package manager, only pacman and apt-get are supported"
    exit 1
fi
