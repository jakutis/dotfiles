#!/usr/bin/env bash

set -o verbose
set -o xtrace

PHPV="5.4.32"
APCV="3.1.14"
CGITV="0.10.2"
NGINXV="1.4.7"
HAPROXYV="1.4.25"
HAPROXYURL="http://haproxy.1wt.eu/download/1.4/src/haproxy-1.4.25.tar.gz"
DARKHTTPDV="1.9"

PACMAN="$(which pacman 2>/dev/null)"
APTGET="$(which apt-get 2>/dev/null)"

DOTFILES="$(realpath "$1")"
VARIA="$(realpath "$2")"
REPOS="$(realpath "$3")"
MACHINE="$(cat "$REPOS/../.varia/machine")"

if ! [ -e "$DOTFILES" ]
then
    echo "DOTFILES at "$DOTFILES" does not exist" 1>&2
    exit 1
fi

if ! [ -e "$REPOS" ]
then
    echo "REPOS at "$REPOS" does not exist" 1>&2
    exit 1
fi
if [ -z "$MACHINE" ]
then
    echo "Machine at "$REPOS/../.varia/machine" is not set" 1>&2
    exit 1
fi

if [ "$MACHINE" = "server" ]
then
    if ! [ -e "$VARIA" ]
    then
        echo "VARIA at "$VARIA" does not exist" 1>&2
        exit 1
    fi
    "$VARIA/server/proftpd/install"
    cd /etc/smokeping
    ln --no-dereference --force --symbolic "$VARIA/server/smokeping-config.d" config.d
fi

if [ "$MACHINE" = "laptop" ]
then
    if ! [ -e "$VARIA" ]
    then
        echo "VARIA at "$VARIA" does not exist" 1>&2
        exit 1
    fi
    pushd .
    cd /etc
    ln --no-dereference --force --symbolic "$VARIA/wpa_supplicant.conf"
    popd
fi

if [ -n "$PACMAN" ]
then
    "$PACMAN" --sync --needed psmisc git vim kdebase-konqueror kdegraphics-okular awesome mplayer-vaapi vlc ffmpeg openssh cups octave coreutils powertop libxslt wavpack lame flac bchunk mp3splt cuetools python2-eyed3 id3lib mp3info faac mac libmp4v2 samba ethtool mercurial texlive-most parted kdegraphics-ksnapshot smartmontools htop dstat dnsmasq protobuf zlib libutempter pkg-config openssl ncurses curl sqlite libxml2 stfl json-c gettext bzip2 markdown pcre libyaml elinks openvpn bridge-utils fetchmail postfix unzip gmp mesa freeglut hdparm parted qt libcups poppler-qt ebtables lsb-release alsa-utils mc smbclient autoconf libsigc++ yajl ntp pragha ethtool wol duplicity ntfs-3g ntfsprogs cmus gramps ejabberd mcabber irssi p7zip imagemagick zip sshfs perl-image-exiftool loudmouth librsvg lftp flex bison intltool python2-cheetah python2-pyopenssl par2cmdline rygel xorg-xdm yasm xorg-xclock xorg-xinput xdotool libpar2 libspectre tidyhtml astyle ack wget xorg vicious virtualbox virtualbox-guest-iso osmo mariadb sudo ebtables dhclient wpa_supplicant beep xbindkeys zenity wmname cmake bzr subversion wvdial sage-mathematics gimp libreoffice sane mirage leafpad gnome-alsamixer skype-call-recorder ifuse python2-lxml wireless_tools patch pkgfile automake libtool dosfstools vpnc tmux pwgen gsasl dos2unix ghc gtkmm poppler-glib python2 tcpdump audacity recoll pstotext antiword catdoc unrtf mutagen python2-pychm aspell-en xchm xclip wireshark-gtk couchdb iw sysstat pinentry scons gstreamer0.10-ugly-plugins gstreamer0.10-good-plugins gstreamer0.10-base-plugins gstreamer0.10-bad-plugins dnsutils thttpd gnuplot libcue calibre libmpcdec gawk gdbm ctags cscope python-scipy python2-scipy gcc gcc-fortran xorg-xinit make pulseaudio pavucontrol clang iotop nload lame usbutils joystick dia inkscape xchm asciidoc docbook2x rtmpdump pv chromium cabextract lm_sensors rxvt-unicode tinyxml libid3tag ccd2iso kdebase-workspace rsync poppler-qt5 re2c || exit 1

    if ! "$PACMAN" --query --list package-query 1>/dev/null 2>&1
    then
        DIR="$( mktemp --directory )"
        cd "$DIR"
        wget https://aur.archlinux.org/packages/pa/package-query/PKGBUILD
        makepkg --asroot
        pacman --upgrade *.pkg.tar.xz
        cd -
        rm --recursive "$DIR"
    fi

    if ! "$PACMAN" -Ql yaourt 1>/dev/null 2>&1
    then
        DIR="$( mktemp --directory )"
        cd "$DIR"
        wget https://aur.archlinux.org/packages/ya/yaourt/PKGBUILD
        makepkg --asroot
        pacman --upgrade *.pkg.tar.xz
        cd -
        rm --recursive "$DIR"
    fi

    for PKG in rar ttf-ms-fonts gdk-pixbuf-psd transmission-cli ttf2eot python2-yenc pdfgrep v4l2loopback-git python-autopep8 ideviceinstaller-git ocrodjvu pdftk teamviewer virtualbox-ext-oracle jbig2enc-git proftpd
    do
        if ! "$PACMAN" --query --list "$PKG" 1>/dev/null 2>&1
        then
            yaourt --sync --noconfirm "$PKG"
        fi
    done
elif [ -n "$APTGET" ]
then
    apt-get install wget && wget --quiet http://download.virtualbox.org/virtualbox/debian/oracle_vbox.asc --output-document=- | sudo apt-key add - || exit 1
    "$APTGET" update || exit 1
    # add when these are in official repositories: pragha gdk-pixbuf-psd autopep8 vicious sage-mathematics libreoffice skype skype-call-recorder ideviceinstaller fuse-google-drive-git teamviewer virtualbox-ext-oracle jbig2enc v4l2loopback thttpd rar ttf-mscorefonts-installer p7zip-rar libpoppler-glib4 libglut3-dev python-pyopenssl
    "$APTGET" install psmisc git vim konqueror okular awesome chromium-browser mplayer vlc ffmpeg openssh-server openssh-client cups octave realpath powertop xsltproc wavpack ffmpeg flac bchunk mp3splt cuetools eyeD3 libid3-tools mp3info samba ethtool mercurial texlive-full parted ksnapshot smartmontools htop dstat dnsmasq libprotobuf-dev libprotobuf-c0-dev protobuf-c-compiler protobuf-compiler libz-dev libutempter-dev pkg-config libssl-dev libncurses-dev g++ curl libsqlite3-dev libxml2-dev libstfl-dev libjson0-dev gettext bzip2 markdown libpcre3-dev libyaml-dev elinks openvpn bridge-utils fetchmail postfix unzip libgmp3-dev libgl1-mesa-dev hdparm parted qt4-qmake libcups2-dev libpoppler-qt4-dev ebtables lsb-release alsa-utils mc smbclient autoconf libsigc++-2.0-dev ntpdate ethtool wakeonlan duplicity ntfs-3g ntfsprogs cmus gramps ejabberd mcabber irssi p7zip imagemagick zip sshfs libimage-exiftool-perl libloudmouth1-dev librsvg2-dev lftp transmission-cli flex bison intltool python-cheetah python-yenc par2 p7zip-full xdm yasm x11-apps xinput xdotool libpar2-0-dev libspectre-dev pdfgrep libcups2-dev tidy astyle gfortran libreadline-dev ack wget virtualbox-4.3 osmo mysql-server sudo ebtables isc-dhcp-client wpasupplicant beep xbindkeys zenity wmname cmake bzr subversion wvdial python-lxml gimp sane mirage leafpad gnome-alsamixer ifuse ocrodjvu pdftk ifrename patch dosfstools tmux pwgen libgsasl7-dev dos2unix ghc libgtkmm-2.4 tcpdump audacity recoll xpdf pstotext antiword catdoc unrtf untex python-mutagen python-chm aspell-en xclip wireshark couchdb iw sysstat pinentry-curses scons proftpd gstreamer0.10-plugins-ugly gstreamer0.10-plugins-good gstreamer0.10-plugins-base gstreamer0.10-plugins-bad dnsutils gnuplot libcue-dev libroar-dev calibre libmpcdec-dev gawk libgdbm-dev ctags cscope python-scipy gcc xinit make pulseaudio pavucontrol vainfo libffi-dev sqlite3 libelf-dev libacl1-dev libattr1-dev libgpm-dev libxpm-dev okular-extra-backends systemsettings libflac-dev libmagic-dev libautotrace-dev libgs-dev libmupdf-dev libgif-dev clang iotop nload lame libbtparse-dev usbutils joystick dia inkscape xchm libmcrypt-dev asciidoc docbook2x rtmpdump pv cabextract libp11-dev libicu-dev libdbus-glib-1-dev libogg-dev libasound2-dev libvorbis-dev libtheora-dev libwavpack-dev libdv-dev libjpeg-dev libpulse-dev libshout-dev libavcodec-dev libbz2-dev libcdaudio-dev libdirac-dev libdca-dev libfaad-dev flite-dev libgme-dev libopenjpeg-dev libkate-dev ladspa-sdk-dev libmms-dev libslv2-dev libmimic-dev libmodplug-dev libmpeg2-4-dev libneon27-gnutls-dev libofa0-dev libopenal-dev libopus-dev librtmp-dev libschroedinger-dev libsoundtouch-dev libspandsp-dev timidity libvo-amrwbenc-dev libvo-aacenc-dev libvpx-dev libwildmidi-dev libxvidcore-dev libzbar-dev libmp3lame-dev libtwolame-dev liba52-dev libopencore-amrnb-dev libopencore-amrwb-dev libcdio-dev libdvdread-dev libmad0-dev libsidplay1-dev libsidplay2-dev libsidutils-dev libx264-dev libxv-dev libxvmc-dev libzzip-dev libjpeg-dev libfreetype6-dev lm-sensors bibutils libfuse-dev libudev-dev libzip-dev rxvt-unicode libtinyxml-dev libid3tag0-dev ccd2iso bsdtar rsync re2c libtidy-dev || exit 1
    ARCH="$( dpkg --print-architecture )"

    if ! dpkg-query --status libgmp3c2 2>&1 1>/dev/null
    then
        wget http://ftp.lt.debian.org/debian/pool/main/g/gmp/libgmp3c2_4.3.2+dfsg-1_amd64.deb || exit 1
        dpkg --install libgmp3c2_4.3.2+dfsg-1_amd64.deb && rm libgmp3c2_4.3.2+dfsg-1_amd64.deb || exit 1
    fi

    # TODO replace the debs below with install-user items
    if false
    then

    if ! dpkg-query --status libfaac-dev 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/f/faac/libfaac-dev_1.28-0.3_$ARCH.deb
        dpkg --install libfaac-dev_1.28-0.3_$ARCH.deb
        rm libfaac-dev_1.28-0.3_$ARCH.deb
    fi

    if ! dpkg-query --status libmp4v2-1 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/m/mp4v2/libmp4v2-1_1.9.1-0.1_$ARCH.deb
        dpkg --install libmp4v2-1_1.9.1-0.1_$ARCH.deb
        rm libmp4v2-1_1.9.1-0.1_$ARCH.deb
    fi

    if ! dpkg-query --status libfaac0 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/f/faac/libfaac0_1.28-0.3_$ARCH.deb
        dpkg --install libfaac0_1.28-0.3_$ARCH.deb
        rm libfaac0_1.28-0.3_$ARCH.deb
    fi

    if ! dpkg-query --status faac 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/f/faac/faac_1.28-0.3_$ARCH.deb
        dpkg --install faac_1.28-0.3_$ARCH.deb
        rm faac_1.28-0.3_$ARCH.deb
    fi

    if ! dpkg-query --status libmac2 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/m/monkeys-audio/libmac2_3.99-u4-b5-0.1_$ARCH.deb
        dpkg --install libmac2_3.99-u4-b5-0.1_$ARCH.deb
        rm libmac2_3.99-u4-b5-0.1_$ARCH.deb
    fi

    if ! dpkg-query --status monkeys-audio 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/m/monkeys-audio/monkeys-audio_3.99-u4-b5-0.1_$ARCH.deb
        dpkg --install monkeys-audio_3.99-u4-b5-0.1_$ARCH.deb
        rm monkeys-audio_3.99-u4-b5-0.1_$ARCH.deb
    fi

    if ! dpkg-query --status libmpeg4ip-0 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/m/mpeg4ip/libmpeg4ip-0_1.6-0.9_$ARCH.deb
        dpkg --install libmpeg4ip-0_1.6-0.9_$ARCH.deb
        rm libmpeg4ip-0_1.6-0.9_$ARCH.deb
    fi

    if ! dpkg-query --status libmp4v2-0 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/m/mpeg4ip/libmp4v2-0_1.6-0.9_$ARCH.deb
        dpkg --install libmp4v2-0_1.6-0.9_$ARCH.deb
        rm libmp4v2-0_1.6-0.9_$ARCH.deb
    fi

    if ! dpkg-query --status mpeg4ip-utils 2>&1 1>/dev/null
    then
        wget http://www.deb-multimedia.org/pool/main/m/mpeg4ip/mpeg4ip-utils_1.6-0.9_$ARCH.deb
        dpkg --install mpeg4ip-utils_1.6-0.9_$ARCH.deb
        rm mpeg4ip-utils_1.6-0.9_$ARCH.deb
    fi

    if ! dpkg-query --status lame 2>&1 1>/dev/null
    then
        wget http://deb-multimedia.org/pool/main/l/lame/lame_3.98.4-0.0_$ARCH.deb
        dpkg --install lame_3.98.4-0.0_$ARCH.deb
        rm lame_3.98.4-0.0_$ARCH.deb
    fi
    fi
else
    echo "Unknown package manager, only pacman and apt-get are supported"
    exit 1
fi

if ! [ -e "/opt/varia-nginx-$NGINXV" ]
then
    mkdir --parents /opt
    cd /opt
    curl -L http://nginx.org/download/nginx-$NGINXV.tar.gz | tar zx || exit 1
    cd nginx-$NGINXV
    ./configure --prefix=/opt/varia-nginx-$NGINXV --with-ipv6 --with-http_ssl_module && make && make install || exit 1
    ln -nsf /opt/varia-nginx-$NGINXV /opt/varia-nginx
    cd ..
    rm -rf "nginx-$NGINXV"
fi

if ! [ -e "/opt/varia-cgit-$CGITV" ]
then
    mkdir --parents /opt
    cd /opt
    curl -L http://git.zx2c4.com/cgit/snapshot/cgit-$CGITV.tar.xz | tar Jx || exit 1
    cd cgit-$CGITV && make get-git && make prefix=/opt/varia-cgit-$CGITV CGIT_SCRIPT_PATH=/opt/varia-cgit-$CGITV/www CGIT_CONFIG=/home/tahu/Desktop/VARIA/server/cgitrc CACHE_ROOT=/tmp/cgit install || exit 1
    cd .. && rm -rf cgit-$CGITV || exit 1
    ln -nsf /opt/varia-cgit-$CGITV /opt/varia-cgit
    cd varia-cgit/www && mv cgit.cgi cgit.cgi-bin && cat "$VARIA/server/cgit.cgi" > cgit.cgi && chmod +x cgit.cgi || exit 1
fi

if ! [ -e "/opt/varia-php-$PHPV" ]
then
    (cd "$REPOS/git/php" && git archive --format=tar --prefix=php-build/ "php-$PHPV") | (cd "/opt" && tar xf -) || exit 1
    (cd "$REPOS/git/apc" && git archive --format=tar --prefix=apc/ "APC-$APCV") | (cd "/opt/php-build/ext" && tar xf -) || exit 1
    cd "/opt/php-build" && ./buildconf --force && ./configure --prefix=/opt/varia-php-$PHPV --with-openssl --with-pdo-mysql --enable-apc --enable-fpm --enable-zip --enable-mbstring --with-gd --with-zlib --with-curl --enable-fileinfo --with-bz2 --enable-intl --with-mcrypt --with-openssl --enable-exif --with-fpm-user=www-data --with-fpm-group=www-data --with-mysql --enable-pcntl && make && make install || exit 1
    cd .. && rm -rf "php-build" && ln -nsf "varia-php-$PHPV" varia-php || exit 1
fi

if ! [ -e "/opt/varia-haproxy-$HAPROXYV" ]
then
    mkdir --parents /opt
    cd /opt
    curl -L "$HAPROXYURL" | tar zx || exit 1
    cd haproxy-$HAPROXYV
    make PREFIX=/opt/varia-haproxy-$HAPROXYV install || exit
    cd ..
    rm -rf haproxy-$HAPROXYV
    ln -nsf varia-haproxy-$HAPROXYV varia-haproxy
fi

if ! [ -e "/opt/varia-darkhttpd-$DARKHTTPDV" ]
then
    mkdir --parents /opt
    cd /opt
    curl --location "http://unix4lyfe.org/darkhttpd/darkhttpd-${DARKHTTPDV}.tar.bz2" | tar jxf - || exit 1
    cd darkhttpd-$DARKHTTPDV
    make || exit 1
    mkdir --parents /opt/varia-darkhttpd-$DARKHTTPDV/bin
    cp darkhttpd /opt/varia-darkhttpd-$DARKHTTPDV/bin
    cd ..
    rm -rf darkhttpd-$DARKHTTPDV
    ln -nsf varia-darkhttpd-$DARKHTTPDV varia-darkhttpd
fi
