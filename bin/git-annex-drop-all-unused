#!/usr/bin/env bash

OUT=$(git annex unused)

if [ "$(echo "$OUT" | wc -l)" = "1" ]
then
    exit 0
fi

UNUSEDPREFIX=$(echo -e "  Some annexed data is no longer used by any files:\n    NUMBER  KEY")
UNUSEDPREFIXL=$(echo "$UNUSEDPREFIX"|wc -l)
REALUNUSEDPREFIX=$(echo "$OUT"|tail -n +2|head -n "$UNUSEDPREFIXL")
if [ "$REALUNUSEDPREFIX" != "$UNUSEDPREFIX" ]
then
    echo "Error: real unused prefix is not equal to expected unused prefix"
    echo "$REALUNUSEDPREFIX"
    echo "------- VERSUS -------"
    echo "$UNUSEDPREFIX"
    exit 1
fi

UNUSEDSUFFIX=$(echo -e "  (To see where data was previously used, try: git log --stat -S'KEY')\n  \n  To remove unwanted data: git-annex dropunused NUMBER\n  \nok")
UNUSEDSUFFIXL=$(echo "$UNUSEDSUFFIX"|wc -l)
REALUNUSEDSUFFIX=$(echo "$OUT"|tail -n "-$UNUSEDSUFFIXL")
if [ "$REALUNUSEDSUFFIX" != "$UNUSEDSUFFIX" ]
then
    echo "Error: real unused suffix is not equal to expected unused suffix"
    echo "$REALUNUSEDSUFFIX"
    echo "------- VERSUS -------"
    echo "$UNUSEDSUFFIX"
    exit 1
fi

COUNT=$(echo "$OUT" | wc -l)
COUNT=$((COUNT - $UNUSEDPREFIXL - $UNUSEDSUFFIXL))
echo "Unused count: $COUNT"

if [ "$COUNT" -gt "0" ]
then
    git annex dropunused "1-$COUNT" --force || exit 1
fi
