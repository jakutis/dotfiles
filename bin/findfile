#!/usr/bin/env bash

OPENER="$3"
FOLDERS="$1"
if ! [ -e "$FOLDERS" ]
then
    echo "File "$FOLDERS" must exist with a space separated list of paths to directories"
    echo "Example:"
    echo "$2"
    exit 1
fi
FOLDERS="$(cat "$FOLDERS")"

shift
shift
shift

GREPS=""
for A in "$@"
do
    GREPS="$GREPS | grep -i "$A""
done

function updateIndex {
    echo "Updating index "$1.7z""
    find "$1" | 7z a -t7z -m0=lzma -mx=9 -mfb=64 -md=32m -ms=on -si "$1.7z"
}

for F in $FOLDERS
do
    echo "---------- $F"
    echo
    if ! [ -e "$F" ]
    then
        echo "Folder does not exist"
        exit 1
    fi
    if ! [ -e "$F.7z" ]
    then
        updateIndex "$F"
    fi
    eval "7z x -so "$F.7z" $GREPS" | (
        while read FILE
        do
            echo "$OPENER \"$FILE\""
            ls -lha "$FILE"
            echo
        done
    )
done
