#!/usr/bin/env bash

COMMAND="$1"
LANG="$2"
VERSION="$3"

if [ "$COMMAND" = "use" ]
then
  if [ "$LANG" = "node" ]
  then
    if [ -z "$VERSION" ]
    then
      VERSION="default"
    fi
    source "$HOME/.nvm/nvm.sh" && nvm use "$VERSION" 1>/dev/null || exit 1
  elif [ "$LANG" = "r" ]
  then
    export R_HOME="$HOME/opt/r-$VERSION"
    if [ ! -e "$R_HOME" ]
    then
      exit 1
    fi
    export TEXINPUTS="$TEXINPUTS:$R_HOME/lib/R/share/texmf/tex/latex"
    export PATH="$R_HOME/bin:$PATH"
  elif [ "$LANG" = "cuda" ]
  then
    export CUDA_HOME="$HOME/opt/cuda-$VERSION"
    if [ ! -e "$CUDA_HOME" ]
    then
      exit 1
    fi
    export PATH="$CUDA_HOME/bin:$PATH"
    export LD_LIBRARY_PATH="$CUDA_HOME/lib64:$CUDA_HOME/lib"
  elif [ "$LANG" = "rust" ]
  then
    export PATH="$HOME/.cargo/bin:$PATH"
    if [ -n "$VERSION" ]
    then
      rustup default "$VERSION" || exit 1
    fi
  elif [ "$LANG" = "llvm" ]
  then
    export LLVM_ROOT="$HOME/opt/llvm-$VERSION"
    if [ ! -e "$LLVM_ROOT" ]
    then
      exit 1
    fi
    export PATH="$LLVM_ROOT/bin:$PATH"
  elif [ "$LANG" = "java" ]
  then
    export JAVA_HOME="$HOME/opt/jdk-$VERSION"
    if [ ! -e "$JAVA_HOME" ]
    then
      exit 1
    fi
    export PATH="$JAVA_HOME/bin:$PATH"
  elif [ "$LANG" = "perl" ]
  then
    if [ -z "$VERSION" ]
    then
      VERSION="default"
    fi
    [[ -s "$PERLBREW_ROOT/etc/bashrc" ]] && source "$PERLBREW_ROOT/etc/bashrc" && perlbrew use "$VERSION" || exit 1
  elif [ "$LANG" = "kotlin" ]
  then
    if [ ! -e "$HOME/opt/kotlin-$VERSION" ]
    then
      exit 1
    fi
    export PATH="$HOME/opt/kotlin-$VERSION/bin:$PATH"
  elif [ "$LANG" = "erlang" ]
  then
    if [ ! -e "$HOME/opt/erlang-$VERSION" ]
    then
      exit 1
    fi
    export PATH="$HOME/opt/erlang-$VERSION/bin:$PATH"
  elif [ "$LANG" = "ghc" ]
  then
    if [ ! -e "$HOME/opt/ghc-$VERSION" ]
    then
      exit 1
    fi
    export PATH="$HOME/opt/ghc-$VERSION/bin:$PATH"
  elif [ "$LANG" = "gcc" ]
  then
    if [ ! -e "$HOME/opt/gcc-$VERSION" ]
    then
      exit 1
    fi
    export PATH="$HOME/opt/gcc-$VERSION/bin:$PATH"
  elif [ "$LANG" = "go" ]
  then
    if [ -z "$VERSION" ]
    then
      VERSION="default"
    fi
    [[ -s "$GVM_ROOT/scripts/gvm-default" ]] && source "$GVM_ROOT/scripts/gvm-default" && gvm use "$VERSION" 1>/dev/null || exit 1
  elif [ "$LANG" = "ocaml" ]
  then
    [[ -s "$HOME/.opam/opam-init/init.sh" ]] && source "$HOME/.opam/opam-init/init.sh" 1>/dev/null 2>/dev/null || exit 1
  elif [ "$LANG" = "php" ]
  then
    if [ -z "$VERSION" ]
    then
      VERSION="$(cat "$HOME/.php")"
    fi
    [[ -s "$HOME/opt/php-version/php-version.sh" ]] && source "$HOME/opt/php-version/php-version.sh" && php-version "$VERSION" || exit 1
    export PATH="$HOME/.composer/vendor/bin:$PATH"
  elif [ "$LANG" = "python" ]
  then
    export PATH="$PYENV_ROOT/bin:$PATH"
    if [ -z "$VERSION" ]
    then
      VERSION="$(pyenv global)"
    fi
    [[ -s "$PYENV_ROOT" ]] && eval "$(pyenv init -)" && pyenv shell "$VERSION" || exit 1
  elif [ "$LANG" = "ruby" ]
  then
    if [ -z "$VERSION" ]
    then
      VERSION="default"
    fi
    [[ -s "$HOME/.rvm/scripts/rvm" ]] && source "$HOME/.rvm/scripts/rvm" && rvm "$VERSION" 2>/dev/null || exit 1
  else
    echo unrecognized language: $LANG 1>&2
    exit 1
  fi
elif [ "$COMMAND" = "install" ]
then
  if [ -z "$LANG" ]
  then
      echo "Please specify language" >&2
      exit 1
  fi

  if [ -z "$VERSION" ]
  then
      echo "Please specify version" >&2
      exit 1
  fi

  PACKAGES="$HOME/.${LANG}packages"
  if ! [ -e "$PACKAGES" ]
  then
      echo "Please create a file "$PACKAGES" with a list of global packages to install"
      exit 1
  fi

  if [ "$LANG" = "node" ]
  then
    if ! [ -e "$HOME/.nvm" ]
    then
        git clone https://github.com/creationix/nvm "$HOME/.nvm" || exit 1
    else
        cd "$HOME/.nvm" && git pull --rebase && cd - || exit 1
    fi

    if [ -e "$HOME/.nvm/versions/node/v$VERSION" ]
    then
      echo "already installed at $HOME/.nvm/versions/node/v$VERSION"
      exit 1
    fi

    source "$HOME/.nvm/nvm.sh" && nvm install "v$VERSION" && nvm alias default "$VERSION" && nvm use default || exit 1

    for PACKAGE in $(cat "$PACKAGES")
    do
        npm install -g $PACKAGE || exit 1
    done
  elif [ "$LANG" = "ruby" ]
  then
    if ! [ -e "$HOME/.rvm" ]
    then
        curl -L https://get.rvm.io | rvm_path="$HOME/.rvm" bash -s stable --ruby="$VERSION" --ignore-dotfiles --autolibs=read-fail && source "$HOME/.rvm/scripts/rvm" || exit 1
    else
        source "$HOME/.rvm/scripts/rvm" && rvm get head || exit 1

        if [ -e "$HOME/.rvm/rubies/ruby-$VERSION" ]
        then
          echo "already installed at $HOME/.rvm/rubies/ruby-$VERSION"
          exit 1
        fi

        rvm install "$VERSION" || exit 1
    fi

    rvm --default use "$VERSION" && rvm default || exit 1

    for PACKAGE in $(cat "$PACKAGES")
    do
        gem install $PACKAGE || exit 1
    done
    #LDFLAGS="-Wl,--rpath=$HOME/opt/graphicsmagick-$GRAPHICSMAGICKV/lib,--enable-new-dtags" CFLAGS="-I$HOME/opt/graphicsmagick-$GRAPHICSMAGICKV/include" CXXFLAGS="-I$HOME/opt/graphicsmagick-$GRAPHICSMAGICKV/include" PKG_CONFIG_PATH="$HOME/opt/graphicsmagick-$GRAPHICSMAGICKV/lib/pkgconfig" gem install jekyll kramdown pdfbeads rmagick iconv hpricot compass travis-lint metaclass blankslate haml bundler lolcat || exit 1
    rvm docs generate-ri || exit 1
  elif [ "$LANG" = "python" ]
  then
    if ! [ -e "$PYENV_ROOT" ]
    then
        git clone https://github.com/pyenv/pyenv "$PYENV_ROOT" || exit 1
    else
        cd "$PYENV_ROOT" && git pull --rebase && cd - || exit 1
    fi

    if [ -e "$PYENV_ROOT/versions/$VERSION" ]
    then
      echo "already installed at $PYENV_ROOT/versions/$VERSION"
      exit 1
    fi

    export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init -)" && pyenv install "$VERSION" && pyenv global "$VERSION" && pyenv shell "$(pyenv global)" || exit 1

    for PACKAGE in $(cat "$PACKAGES")
    do
        pip install $PACKAGE || exit 1
    done
  fi
elif [ "$COMMAND" = "versions" ]
then
  function check {
    NAME="$2"
    if [ -z "$NAME" ]
    then
      NAME="$1"
    fi

    BIN=$(which "$1" 2>/dev/null)
    if [ -n "$BIN" ]
    then
      echo "# $NAME -> $BIN"
      echo ===============================
    else
      echo "# $NAME -> NONE"
      echo ===============================
      return 1
    fi
  }

  check ruby && ruby --version || true
  echo

  check node && node --version || true
  echo

  check python && python --version || true
  echo

  check java && java -version || true
  echo

  check rustc rust && rustc --version || true
  echo

  check php && php --version || true
  echo

  check ocaml && ocaml --version || true
  echo

  check go && go version || true
  echo

  check gcc && gcc --version || true
  echo

  check ghc && ghc --version || true
  echo

  check erl erlang && erl -version || true
  echo

  check kotlinc kotlin && kotlinc -version || true
  echo

  check perl && perl --version || true
  echo

  check clang llvm && clang --version || true
  echo

  check R r && R --version || true
  echo

  check nvcc cuda && nvcc --version || true
  echo

fi
